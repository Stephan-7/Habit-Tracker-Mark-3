<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Habit OS â€” Gemini Light Planner (Integrated)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { border: "rgba(0,0,0,0.06)" },
          boxShadow: { soft: "0 8px 30px rgba(16,24,40,0.06)" }
        }
      }
    };
  </script>
  <style>
    :root { --bg:#f5f6f8; --card:rgba(255,255,255,0.78); }
    html,body { height:100%; margin:0; background:var(--bg); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .glass { background:var(--card); backdrop-filter: blur(8px); }
    .border-soft { border:1px solid rgba(15,23,42,0.06); }
    .shadow-soft { box-shadow:0 8px 30px rgba(16,24,40,0.06); }
    .heat-square { width:12px; height:12px; border-radius:3px; flex:0 0 auto; }
    #app { min-height:100vh; padding:28px; box-sizing:border-box; display:flex; align-items:stretch; }
    .modal-backdrop { background: rgba(0,0,0,0.35); backdrop-filter: blur(4px); }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Modal Editor -->
  <div id="editorModal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
    <div class="glass border-soft rounded-2xl shadow-soft w-full max-w-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="text-lg font-semibold">New Item</div>
        <button id="closeEditor" class="text-sm px-3 py-1 rounded-md border border-gray-200">Close</button>
      </div>
      <form id="editorForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-gray-600">Name</label>
          <input id="f_name" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200" required />
        </div>
        <div>
          <label class="text-xs text-gray-600">Type</label>
          <select id="f_type" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200">
            <option value="habit">Routine</option>
            <option value="task">Task</option>
            <option value="event">Event</option>
            <option value="birthday">Birthday</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-gray-600">Category</label>
          <select id="f_category" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200">
            <option>General</option><option>Health</option><option>Work</option><option>Social</option><option>Learning</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-600">Difficulty</label>
          <select id="f_difficulty" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200">
            <option>Easy</option><option>Medium</option><option>Heroic</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-gray-600">Monthly goal (optional)</label>
          <input id="f_goal" type="number" min="1" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200" placeholder="e.g., 15" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Time (optional)</label>
          <input id="f_time" type="time" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200" />
        </div>

        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Frequency (for routines)</label>
          <div class="mt-2 flex gap-2">
            <button type="button" data-day="0" class="freq-btn px-2 py-1 rounded-full border border-gray-200 text-xs">S</button>
            <button type="button" data-day="1" class="freq-btn px-2 py-1 rounded-full border border-gray-200 text-xs">M</button>
            <button type="button" data-day="2" class="freq-btn px-2 py-1 rounded-full border border-gray-200 text-xs">T</button>
            <button type="button" data-day="3" class="freq-btn px-2 py-1 rounded-full border border-gray-200 text-xs">W</button>
            <button type="button" data-day="4" class="freq-btn px-2 py-1 rounded-full border border-gray-200 text-xs">T</button>
            <button type="button" data-day="5" class="freq-btn px-2 py-1 rounded-full border border-gray-200 text-xs">F</button>
            <button type="button" data-day="6" class="freq-btn px-2 py-1 rounded-full border border-gray-200 text-xs">S</button>
          </div>
        </div>

        <div>
          <label class="text-xs text-gray-600">Date (for task/event/birthday)</label>
          <input id="f_date" type="date" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200" />
        </div>
        <div>
          <label class="text-xs text-gray-600">Use focus timer</label>
          <div class="mt-1">
            <label class="inline-flex items-center gap-2">
              <input id="f_timer" type="checkbox" class="rounded" />
              <span class="text-sm text-gray-600">Enable</span>
            </label>
          </div>
        </div>

        <div class="md:col-span-2 flex items-center justify-end gap-2 mt-2">
          <button type="button" id="cancelEditor" class="px-4 py-2 rounded-lg border border-gray-200">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Timer overlay -->
  <div id="timerOverlay" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
    <div class="glass border-soft rounded-2xl shadow-soft w-full max-w-sm p-6">
      <div class="text-xs uppercase text-gray-500">Focus Session</div>
      <div id="timerTime" class="text-4xl font-semibold my-3">25:00</div>
      <div id="timerLabel" class="text-sm text-gray-700 mb-4"></div>
      <div class="flex justify-center">
        <button id="timerCancel" class="px-4 py-2 rounded-lg border border-gray-200">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* -------------------------
   Storage + utils
------------------------- */
const LS_KEY = "habit_os_gemini_full";
const todayStr = () => new Date().toISOString().slice(0,10);
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const dateObj = s => new Date(s + "T00:00:00");
const ymd = d => d.toISOString().slice(0,10);
const fmtMonthYear = d => d.toLocaleDateString(undefined,{month:"long",year:"numeric"});
const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; } catch { return null; } };
const emptyStore = () => ({
  habits: [],
  completions: {},
  settings: { theme:"light", vacationMode:false, backupId:"user_"+Math.random().toString(36).slice(2,8) },
  view: { selectedDate: todayStr(), monthOffset:0, manualSort:false }
});
let store = load() || emptyStore();
const save = () => localStorage.setItem(LS_KEY, JSON.stringify(store));

/* -------------------------
   due/completion logic
------------------------- */
const addCompletion = (date,id) => {
  const c = store.completions[date] || [];
  if (!c.includes(id)) c.push(id);
  store.completions[date] = c;
};
const removeCompletion = (date,id) => {
  const c = store.completions[date] || [];
  store.completions[date] = c.filter(x => x !== id);
  if (!store.completions[date].length) delete store.completions[date];
};

const isDue = (h,date) => {
  const d = dateObj(date), dow = d.getDay();
  if (h.type === "habit") {
    const freq = (h.frequency && h.frequency.length) ? h.frequency : [0,1,2,3,4,5,6];
    return !h.archived && freq.includes(dow);
  }
  if (h.type === "task") return !h.archived && h.targetDate === date;
  if (h.type === "event") return !h.archived && h.targetDate === date;
  if (h.type === "birthday") {
    if (!h.targetDate) return false;
    const td = dateObj(h.targetDate);
    return !h.archived && td.getDate() === d.getDate() && td.getMonth() === d.getMonth();
  }
  return false;
};
const dueItems = date => store.habits.filter(h => isDue(h,date) && !h.archived);

/* -------------------------
   calendar/heatmap helpers
------------------------- */
const dayStats = date => {
  const due = store.habits.filter(h => ["habit","task"].includes(h.type) && isDue(h,date));
  const done = store.completions[date] || [];
  return { total: due.length, done: done.length };
};
const last30 = () => {
  const arr = []; const base = dateObj(todayStr());
  for (let i=29;i>=0;i--){ const d=new Date(base); d.setDate(d.getDate()-i); const ds=ymd(d); arr.push({date:ds,...dayStats(ds)}); }
  return arr;
};
const monthDays = offset => {
  const base = new Date(); base.setDate(1); base.setMonth(base.getMonth()+offset);
  const year = base.getFullYear(), month = base.getMonth();
  const first = new Date(year,month,1), startDow = first.getDay();
  const daysIn = new Date(year,month+1,0).getDate();
  const cells = [];
  for (let i=0;i<startDow;i++) cells.push(null);
  for (let d=1;d<=daysIn;d++) cells.push(new Date(year,month,d));
  return {cells,monthDate:first};
};

/* -------------------------
   editor modal logic
------------------------- */
const editorModal = document.getElementById("editorModal");
const editorForm = document.getElementById("editorForm");
const openEditor = (h=null) => {
  // populate form
  const f = (h ? h : {
    id: uid(), name:"", type:"habit", category:"General", difficulty:"Easy",
    monthlyGoal:null, time:"", frequency:[1,2,3,4,5], targetDate:todayStr(), useTimer:false
  });
  document.getElementById("f_name").value = f.name || "";
  document.getElementById("f_type").value = f.type || "habit";
  document.getElementById("f_category").value = f.category || "General";
  document.getElementById("f_difficulty").value = f.difficulty || "Easy";
  document.getElementById("f_goal").value = f.monthlyGoal || "";
  document.getElementById("f_time").value = f.time || "";
  document.getElementById("f_date").value = f.targetDate || "";
  document.getElementById("f_timer").checked = !!f.useTimer;
  // frequency buttons
  document.querySelectorAll(".freq-btn").forEach(btn => {
    const day = parseInt(btn.getAttribute("data-day"));
    const active = (f.frequency || [0,1,2,3,4,5,6]).includes(day);
    btn.classList.toggle("bg-indigo-600", active);
    btn.classList.toggle("text-white", active);
  });
  editorModal.dataset.editId = h ? h.id : "";
  editorModal.classList.remove("hidden");
};
document.getElementById("closeEditor").onclick = () => editorModal.classList.add("hidden");
document.getElementById("cancelEditor").onclick = () => editorModal.classList.add("hidden");
document.querySelectorAll(".freq-btn").forEach(btn => {
  btn.onclick = () => {
    btn.classList.toggle("bg-indigo-600");
    btn.classList.toggle("text-white");
  };
});
editorForm.onsubmit = (e) => {
  e.preventDefault();
  const id = editorModal.dataset.editId || uid();
  const name = document.getElementById("f_name").value.trim() || "Untitled";
  const type = document.getElementById("f_type").value;
  const category = document.getElementById("f_category").value;
  const difficulty = document.getElementById("f_difficulty").value;
  const monthlyGoal = document.getElementById("f_goal").value ? parseInt(document.getElementById("f_goal").value) : null;
  const time = document.getElementById("f_time").value || "";
  const targetDate = document.getElementById("f_date").value || todayStr();
  const useTimer = document.getElementById("f_timer").checked;
  const freq = Array.from(document.querySelectorAll(".freq-btn"))
    .filter(b => b.classList.contains("bg-indigo-600"))
    .map(b => parseInt(b.getAttribute("data-day")));
  const item = { id, name, type, category, difficulty, monthlyGoal, time, targetDate, useTimer, frequency: freq.length ? freq : [0,1,2,3,4,5,6], archived:false, order: store.habits.length };
  const existing = store.habits.find(x => x.id === id);
  if (existing) {
    const idx = store.habits.findIndex(x => x.id === id);
    store.habits[idx] = item;
  } else {
    store.habits.push(item);
  }
  // if dated item, select date and adjust month
  if (type === "task" || type === "event" || type === "birthday") {
    store.view.selectedDate = targetDate;
    const t = dateObj(targetDate), now = new Date();
    const monthDiff = (t.getFullYear()-now.getFullYear())*12 + (t.getMonth()-now.getMonth());
    store.view.monthOffset = monthDiff;
  }
  save();
  editorModal.classList.add("hidden");
  render();
};

/* -------------------------
   timer
------------------------- */
let timerId = null, timerRemaining = 0, timerHabitId = null, timerDate = null;
const startTimer = (id,date) => {
  const h = store.habits.find(x => x.id === id); if (!h) return;
  timerHabitId = id; timerDate = date; timerRemaining = 25*60;
  document.getElementById("timerLabel").textContent = `${h.name}`;
  document.getElementById("timerOverlay").classList.remove("hidden");
  updateTimerDisplay();
  if (timerId) clearInterval(timerId);
  timerId = setInterval(()=>{ timerRemaining--; if (timerRemaining<=0){ clearInterval(timerId); timerId=null; addCompletion(timerDate,timerHabitId); save(); render(); closeTimer(); } else updateTimerDisplay(); },1000);
};
const updateTimerDisplay = ()=>{ const m=Math.floor(timerRemaining/60).toString().padStart(2,"0"); const s=(timerRemaining%60).toString().padStart(2,"0"); const el=document.getElementById("timerTime"); if(el) el.textContent=`${m}:${s}`; };
const closeTimer = ()=>{ document.getElementById("timerOverlay").classList.add("hidden"); if(timerId){ clearInterval(timerId); timerId=null; } };
document.getElementById("timerCancel").onclick = closeTimer;

/* -------------------------
   export/import
------------------------- */
const exportJson = ()=>{ const blob=new Blob([JSON.stringify(store)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="habit_os_backup.json"; a.click(); URL.revokeObjectURL(a.href); };
const importJson = ()=>{ const inp=document.createElement("input"); inp.type="file"; inp.accept=".json"; inp.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ store=JSON.parse(ev.target.result); save(); render(); }catch{ alert("Invalid file"); } }; r.readAsText(f); }; inp.click(); };

/* -------------------------
   render
------------------------- */
const render = () => {
  const root = document.getElementById("app");
  const sel = store.view.selectedDate;
  const month = monthDays(store.view.monthOffset);
  const days = month.cells;
  const monthLabel = fmtMonthYear(month.monthDate);
  const items = dueItems(sel);

  // sidebar cards
  const sidebarList = store.habits.filter(h=>!h.archived).sort((a,b)=>store.view.manualSort? a.order-b.order : a.name.localeCompare(b.name)).map(h=>`
    <div class="glass border-soft rounded-xl p-3 flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-white border border-gray-100 flex items-center justify-center text-lg">${h.icon||"â€¢"}</div>
      <div class="flex-1">
        <div class="text-sm font-medium">${h.name}</div>
        <div class="text-xs text-gray-500 mt-0.5">${h.type} â€¢ ${h.category || "General"}</div>
      </div>
      <div class="flex flex-col gap-2 items-end">
        <button data-edit="${h.id}" class="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100">Edit</button>
      </div>
    </div>
  `).join("");

  // calendar header
  const week = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const calHead = week.map(w=>`<div class="text-xs text-gray-500 text-center">${w}</div>`).join("");

  // calendar cells with small dots
  const calCells = days.map(d=>{
    if(!d) return `<div></div>`;
    const ds = ymd(d);
    const isSel = ds === sel;
    const classes = isSel ? "bg-indigo-50 border border-indigo-200" : "hover:bg-gray-100";
    const dots = store.habits.map(h=>{
      if(h.type==="event" && isDue(h,ds)) return `<span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>`;
      if(h.type==="birthday" && isDue(h,ds)) return `<span class="w-1.5 h-1.5 rounded-full bg-pink-400"></span>`;
      return "";
    }).filter(Boolean).slice(0,3).join("");
    return `<button data-date="${ds}" class="rounded-xl px-2 py-2 text-sm text-center ${classes} flex flex-col items-center gap-1">
      <div class="text-sm font-medium">${d.getDate()}</div>
      <div class="flex gap-1">${dots}</div>
    </button>`;
  }).join("");

  // heatmap
  const heat = last30().map(d=>{
    const pct = d.total ? d.done/d.total : 0;
    const color = pct===1 ? "bg-indigo-600" : pct>=0.5 ? "bg-indigo-400" : pct>0 ? "bg-indigo-200" : "bg-gray-200";
    return `<div class="heat-square ${color}" title="${d.date}"></div>`;
  }).join("");

  // agenda cards
  const agenda = items.length ? items.map(h=>{
    const done = (store.completions[sel]||[]).includes(h.id);
    return `
      <div class="glass border-soft rounded-xl px-4 py-3 shadow-soft flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-2xl">${h.icon||"â€¢"}</div>
          <div>
            <div class="text-sm font-medium">${h.name}</div>
            <div class="text-xs text-gray-500 mt-0.5">${h.type}${h.time?` â€¢ ${h.time}`:""}</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          ${h.useTimer && ["habit","task"].includes(h.type) ? `<button data-timer="${h.id}" class="px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-100 text-xs">Start</button>` : ""}
          <button data-toggle="${h.id}" class="px-3 py-1 rounded-md border border-gray-200 text-xs ${done ? "bg-emerald-50" : ""}">${done ? "Done" : "Mark"}</button>
        </div>
      </div>
    `;
  }).join("") : `
    <div class="flex flex-col items-center justify-center text-center py-12 text-gray-400">
      <div class="text-5xl mb-3">ðŸŽˆ</div>
      <div class="text-sm">Nothing scheduled</div>
    </div>
  `;

  // render full-bleed layout
  root.innerHTML = `
    <div class="w-full flex gap-6" style="align-items:stretch;">
      <aside style="width:260px;" class="flex-shrink-0">
        <div class="glass border-soft rounded-2xl shadow-soft p-4 flex flex-col gap-4 h-full">
          <div>
            <div class="text-lg font-semibold">Habit OS</div>
            <div class="text-xs text-gray-500 mt-1">Local Mode</div>
          </div>
          <div class="text-xs text-gray-500">Backup ID</div>
          <div class="text-sm font-mono bg-white px-3 py-2 rounded-xl border border-gray-100">${store.settings.backupId}</div>
          <div class="mt-3 text-xs text-gray-500">All Items</div>
          <div class="flex flex-col gap-3 overflow-y-auto" style="max-height:calc(100vh - 320px); padding-right:6px;">${sidebarList}</div>
          <button id="addLeft" class="mt-auto px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500">+ Add Item</button>
        </div>
      </aside>

      <main class="flex-1 flex flex-col gap-4">
        <div class="glass border-soft rounded-2xl shadow-soft p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm font-medium">${monthLabel}</div>
            <div class="flex items-center gap-2">
              <button id="prevMonth" class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-100 text-xs">â—€</button>
              <button id="todayBtn" class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-100 text-xs">Today</button>
              <button id="nextMonth" class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-100 text-xs">â–¶</button>
            </div>
          </div>
          <div class="grid grid-cols-7 gap-2 mb-2">${calHead}</div>
          <div class="grid grid-cols-7 gap-2">${calCells}</div>
        </div>

        <div class="glass border-soft rounded-2xl shadow-soft p-4">
          <div class="text-xs text-gray-500 mb-2">Consistency</div>
          <div class="flex gap-1 overflow-x-auto py-1">${heat}</div>
        </div>
      </main>

      <aside style="width:320px;" class="flex-shrink-0">
        <div class="glass border-soft rounded-2xl shadow-soft p-4 flex flex-col gap-4 h-full">
          <div>
            <div class="text-lg font-semibold">${sel}</div>
            <div class="text-xs text-gray-500 mt-1">Your day</div>
          </div>
          <div class="flex flex-col gap-3 overflow-y-auto" style="max-height:calc(100vh - 260px); padding-right:6px;">${agenda}</div>
          <button id="addRight" class="mt-auto px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500">+ Add Item</button>
        </div>
      </aside>
    </div>

    <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
      <div>Light planner â€¢ Local storage</div>
      <div class="flex items-center gap-2">
        <button id="exportBtn" class="px-3 py-1 rounded-md border border-gray-200 hover:bg-gray-100">Export</button>
        <button id="importBtn" class="px-3 py-1 rounded-md border border-gray-200 hover:bg-gray-100">Import</button>
      </div>
    </div>
  `;

  // bindings
  document.getElementById("addLeft").onclick = () => openEditor();
  document.getElementById("addRight").onclick = () => openEditor();
  document.getElementById("exportBtn").onclick = exportJson;
  document.getElementById("importBtn").onclick = importJson;
  document.getElementById("prevMonth").onclick = ()=>{ store.view.monthOffset--; save(); render(); };
  document.getElementById("nextMonth").onclick = ()=>{ store.view.monthOffset++; save(); render(); };
  document.getElementById("todayBtn").onclick = ()=>{ store.view.selectedDate = todayStr(); store.view.monthOffset = 0; save(); render(); };

  document.querySelectorAll("[data-edit]").forEach(el=> el.onclick = ()=>{ const id=el.getAttribute("data-edit"); const h=store.habits.find(x=>x.id===id); openEditor(h); });

  document.querySelectorAll("[data-date]").forEach(el=> el.onclick = ()=>{ const d=el.getAttribute("data-date"); if(!d) return; store.view.selectedDate = d; save(); render(); });

  document.querySelectorAll("[data-toggle]").forEach(el=> el.onclick = ()=>{ const id=el.getAttribute("data-toggle"); const date = store.view.selectedDate; const done = (store.completions[date]||[]).includes(id); if(done) removeCompletion(date,id); else addCompletion(date,id); save(); render(); });

  document.querySelectorAll("[data-timer]").forEach(el=> el.onclick = ()=>{ const id=el.getAttribute("data-timer"); startTimer(id, store.view.selectedDate); });
};

/* seed */
if(!store.habits.length){
  store.habits.push({
    id: uid(), name: "Daily Planning", type: "habit", icon: "ðŸ§ ", category:"Work",
    frequency:[1,2,3,4,5], monthlyGoal:20, useTimer:true, archived:false, order:0, time:""
  });
  save();
}
render();
</script>
</body>
</html>
