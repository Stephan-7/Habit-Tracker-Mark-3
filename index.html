<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Habit OS â€” Light Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            glass: "rgba(255,255,255,0.55)",
            border: "rgba(0,0,0,0.08)",
            soft: "#f7f7f8",
          },
          boxShadow: {
            soft: "0 4px 20px rgba(0,0,0,0.06)",
          },
        },
      },
    };
  </script>

  <style>
    body {
      background: #f5f6f7;
    }
    .glass {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.65);
    }
  </style>
</head>

<body class="text-gray-800">
  <div id="app" class="w-full max-w-[1600px] mx-auto px-6 py-6"></div>

  <!-- Timer Overlay -->
  <div id="timerOverlay" class="fixed inset-0 hidden items-center justify-center bg-black/40 backdrop-blur-sm z-50">
    <div class="glass border border-border rounded-2xl shadow-soft px-8 py-6 flex flex-col items-center gap-4">
      <div class="text-xs uppercase tracking-wide text-gray-500">Focus Session</div>
      <div id="timerTime" class="text-5xl font-semibold tabular-nums">25:00</div>
      <div id="timerLabel" class="text-base text-gray-700"></div>
      <button id="timerCancel" class="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">
        Cancel
      </button>
    </div>
  </div>

<script>
/* -------------------------------------------------------
   STORAGE + UTILITIES
------------------------------------------------------- */
const LS_KEY = "habit_os_v1_lightplanner";
const todayStr = () => new Date().toISOString().slice(0, 10);
const clone = (o) => JSON.parse(JSON.stringify(o));
const load = () => {
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; }
  catch { return null; }
};
const emptyStore = () => ({
  habits: [],
  completions: {},
  settings: { theme: "light", vacationMode: false },
  view: { selectedDate: todayStr(), monthOffset: 0, manualSort: false }
});
let store = load() || emptyStore();
const save = () => localStorage.setItem(LS_KEY, JSON.stringify(store));

const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
const dateObj = (s) => new Date(s + "T00:00:00");
const ymd = (d) => d.toISOString().slice(0, 10);
const fmtMonthYear = (d) => d.toLocaleDateString(undefined, { month: "long", year: "numeric" });

/* -------------------------------------------------------
   COMPLETIONS
------------------------------------------------------- */
const addCompletion = (date, id) => {
  const c = store.completions[date] || [];
  if (!c.includes(id)) c.push(id);
  store.completions[date] = c;
};
const removeCompletion = (date, id) => {
  const c = store.completions[date] || [];
  store.completions[date] = c.filter((x) => x !== id);
  if (!store.completions[date].length) delete store.completions[date];
};

/* -------------------------------------------------------
   DUE LOGIC
------------------------------------------------------- */
const isDue = (h, date) => {
  const d = dateObj(date);
  const dow = d.getDay();

  if (h.type === "habit") {
    const freq = h.frequency?.length ? h.frequency : [0,1,2,3,4,5,6];
    return !h.archived && freq.includes(dow);
  }
  if (h.type === "task") return !h.archived && h.targetDate === date;
  if (h.type === "event") return !h.archived && h.targetDate === date;

  if (h.type === "birthday") {
    if (!h.targetDate) return false;
    const td = dateObj(h.targetDate);
    return !h.archived && td.getDate() === d.getDate() && td.getMonth() === d.getMonth();
  }
  return false;
};

const dueItems = (date) =>
  store.habits.filter((h) => isDue(h, date) && !h.archived);

/* -------------------------------------------------------
   CALENDAR + HEATMAP
------------------------------------------------------- */
const dayStats = (date) => {
  const due = store.habits.filter((h) => ["habit","task"].includes(h.type) && isDue(h, date));
  const done = store.completions[date] || [];
  return { total: due.length, done: done.length };
};

const last30 = () => {
  const arr = [];
  const base = dateObj(todayStr());
  for (let i = 29; i >= 0; i--) {
    const d = new Date(base);
    d.setDate(d.getDate() - i);
    const ds = ymd(d);
    const st = dayStats(ds);
    arr.push({ date: ds, ...st });
  }
  return arr;
};

const monthDays = (offset) => {
  const base = new Date();
  base.setDate(1);
  base.setMonth(base.getMonth() + offset);

  const year = base.getFullYear();
  const month = base.getMonth();
  const first = new Date(year, month, 1);
  const startDow = first.getDay();
  const daysIn = new Date(year, month + 1, 0).getDate();

  const cells = [];
  for (let i = 0; i < startDow; i++) cells.push(null);
  for (let d = 1; d <= daysIn; d++) cells.push(new Date(year, month, d));

  return { cells, monthDate: first };
};

/* -------------------------------------------------------
   EDITOR
------------------------------------------------------- */
const openEditor = (h) => {
  const base = h ? clone(h) : {
    id: uid(),
    name: "",
    type: "habit",
    icon: "â€¢",
    targetDate: todayStr(),
    frequency: [1,2,3,4,5],
    monthlyGoal: null,
    useTimer: false,
    archived: false,
    order: store.habits.length
  };

  const name = prompt("Name", base.name);
  if (name === null) return;
  base.name = name.trim() || "Untitled";

  const type = prompt("Type: habit/task/event/birthday", base.type) || base.type;
  base.type = ["habit","task","event","birthday"].includes(type) ? type : "habit";

  const icon = prompt("Emoji icon", base.icon) || base.icon;
  base.icon = icon;

  if (["task","event","birthday"].includes(base.type)) {
    const td = prompt("Date (YYYY-MM-DD)", base.targetDate) || base.targetDate;
    base.targetDate = td;
  } else {
    const freqStr = prompt("Frequency days (0-6 comma)", base.frequency.join(",")) || "";
    base.frequency = freqStr
      ? freqStr.split(",").map((x) => parseInt(x.trim())).filter((x) => x >= 0 && x <= 6)
      : [0,1,2,3,4,5,6];
  }

  const goal = prompt("Monthly goal (blank=none)", base.monthlyGoal ?? "");
  base.monthlyGoal = goal ? parseInt(goal) || null : null;

  base.useTimer = confirm("Use focus timer?");

  if (h) {
    const idx = store.habits.findIndex((x) => x.id === h.id);
    store.habits[idx] = base;
  } else {
    store.habits.push(base);
  }

  store.habits.forEach((hh, i) => (hh.order = i));
  save();
  render();
};

/* -------------------------------------------------------
   TIMER
------------------------------------------------------- */
let timerId = null;
let timerRemaining = 0;
let timerHabitId = null;
let timerDate = null;

const startTimer = (id, date) => {
  const h = store.habits.find((x) => x.id === id);
  timerHabitId = id;
  timerDate = date;
  timerRemaining = 25 * 60;

  document.getElementById("timerOverlay").classList.remove("hidden");
  document.getElementById("timerLabel").textContent = `${h.icon} ${h.name}`;

  updateTimerDisplay();

  if (timerId) clearInterval(timerId);
  timerId = setInterval(() => {
    timerRemaining--;
    if (timerRemaining <= 0) {
      clearInterval(timerId);
      timerId = null;
      addCompletion(timerDate, timerHabitId);
      save();
      render();
      closeTimer();
    } else updateTimerDisplay();
  }, 1000);
};

const updateTimerDisplay = () => {
  const m = Math.floor(timerRemaining / 60).toString().padStart(2, "0");
  const s = (timerRemaining % 60).toString().padStart(2, "0");
  document.getElementById("timerTime").textContent = `${m}:${s}`;
};

const closeTimer = () => {
  document.getElementById("timerOverlay").classList.add("hidden");
  if (timerId) {
    clearInterval(timerId);
    timerId = null;
  }
};

document.getElementById("timerCancel").onclick = closeTimer;

/* -------------------------------------------------------
   RENDER
------------------------------------------------------- */
const render = () => {
  const app = document.getElementById("app");
  const sel = store.view.selectedDate;
  const month = monthDays(store.view.monthOffset);
  const days = month.cells;
  const monthLabel = fmtMonthYear(month.monthDate);

  const items = dueItems(sel);

  /* Sidebar list */
  const sidebarList = store.habits
    .filter((h) => !h.archived)
    .sort((a, b) => store.view.manualSort ? a.order - b.order : a.name.localeCompare(b.name))
    .map(
      (h) => `
      <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-gray-100 flex items-center gap-2"
              data-edit="${h.id}">
        <span class="text-lg">${h.icon}</span>
        <span class="text-sm">${h.name}</span>
      </button>`
    )
    .join("");

  /* Calendar grid */
  const week = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const calHead = week
    .map((w) => `<div class="text-xs text-gray-500 text-center">${w}</div>`)
    .join("");

  const calCells = days
    .map((d) => {
      if (!d) return `<div></div>`;
      const ds = ymd(d);
      const isSel = ds === sel;
      return `
        <button data-date="${ds}"
          class="rounded-xl px-2 py-2 text-sm text-center hover:bg-gray-100
                 ${isSel ? "bg-indigo-100 border border-indigo-300" : "border border-transparent"}">
          ${d.getDate()}
        </button>`;
    })
    .join("");

  /* Heatmap */
  const heat = last30()
    .map((d) => {
      const pct = d.total ? d.done / d.total : 0;
      const color =
        pct === 1 ? "bg-indigo-500" :
        pct >= 0.5 ? "bg-indigo-300" :
        pct > 0 ? "bg-indigo-200" :
        "bg-gray-200";
      return `<div class="w-3 h-3 rounded-md ${color}"></div>`;
    })
    .join("");

  /* Day details */
  const agenda = items.length
    ? items
        .map(
          (h) => `
        <div class="glass border border-border rounded-xl px-4 py-3 shadow-soft flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="text-xl">${h.icon}</div>
            <div>
              <div class="text-sm font-medium">${h.name}</div>
              <div class="text-xs text-gray-500">${h.type}</div>
            </div>
          </div>
          ${
            h.useTimer
              ? `<button data-timer="${h.id}" class="px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-100 text-xs">Start</button>`
              : ""
          }
        </div>`
        )
        .join("")
    : `
      <div class="flex flex-col items-center justify-center text-center py-12 text-gray-400">
        <div class="text-5xl mb-3">ðŸŽˆ</div>
        <div class="text-sm">Nothing scheduled</div>
      </div>`;

  /* Full layout */
  app.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-[260px,1fr,320px] gap-6">

      <!-- LEFT SIDEBAR -->
      <div class="glass border border-border rounded-2xl shadow-soft p-4 flex flex-col gap-4">
        <div>
          <div class="text-lg font-semibold">Habit OS</div>
          <div class="text-xs text-gray-500">Local Mode</div>
        </div>

        <div class="text-xs text-gray-500">Backup ID</div>
        <div class="text-sm font-mono bg-gray-100 px-3 py-2 rounded-xl border border-gray-200">
          user_${uid().slice(0, 6)}
        </div>

        <div class="mt-4 text-xs text-gray-500">All Items</div>
        <div class="flex flex-col gap-1 max-h-[400px] overflow-y-auto pr-1">
          ${sidebarList}
        </div>

        <button id="addHabit"
          class="mt-auto px-4 py-2 rounded-xl bg-indigo-500 text-white text-sm hover:bg-indigo-400">
          + Add Item
        </button>
      </div>

      <!-- CENTER CALENDAR -->
      <div class="flex flex-col gap-4">
        <div class="glass border border-border rounded-2xl shadow-soft p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm font-medium">${monthLabel}</div>
            <div class="flex items-center gap-2">
              <button id="prevMonth" class="px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-100 text-xs">â—€</button>
              <button id="todayBtn" class="px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-100 text-xs">Today</button>
              <button id="nextMonth" class="px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-100 text-xs">â–¶</button>
            </div>
          </div>

          <div class="grid grid-cols-7 gap-2 mb-2">${calHead}</div>
          <div class="grid grid-cols-7 gap-2">${calCells}</div>
        </div>

        <div class="glass border border-border rounded-2xl shadow-soft p-4">
          <div class="text-xs text-gray-500 mb-2">Consistency</div>
          <div class="grid grid-cols-30 gap-1">${heat}</div>
        </div>
      </div>

      <!-- RIGHT DAY VIEW -->
      <div class="glass border border-border rounded-2xl shadow-soft p-4 flex flex-col gap-4">
        <div>
          <div class="text-lg font-semibold">${sel}</div>
          <div class="text-xs text-gray-500">Your day</div>
        </div>

        <div class="flex flex-col gap-3 max-h-[420px] overflow-y-auto pr-1">
          ${agenda}
        </div>

        <button id="addHabit2"
          class="mt-auto px-4 py-2 rounded-xl bg-indigo-500 text-white text-sm hover:bg-indigo-400">
          + Add Item
        </button>
      </div>

    </div>
  `;

  /* Event bindings */
  document.getElementById("addHabit").onclick = () => openEditor();
  document.getElementById("addHabit2").onclick = () => openEditor();

  document.querySelectorAll("[data-edit]").forEach((el) => {
    el.onclick = () => {
      const id = el.getAttribute("data-edit");
      const h = store.habits.find((x) => x.id === id);
      openEditor(h);
    };
  });

  document.querySelectorAll("[data-date]").forEach((el) => {
    el.onclick = () => {
      store.view.selectedDate = el.getAttribute("data-date");
      save();
      render();
    };
  });

  document.getElementById("prevMonth").onclick =
