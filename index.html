<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Habit OS â€” Friendly Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1: #f6f7fb;
    --bg-2: #eef1fb;
    --muted: #6b7280;
    --card: rgba(255,255,255,0.86);
    --glass-2: rgba(255,255,255,0.94);
    --accent-1: #6b46ff;
    --accent-2: #7c3aed;
    --success: #10b981;
    --danger: #ef4444;
    --radius: 14px;
    --shadow-soft: 0 10px 30px rgba(16,24,40,0.06);
    --shadow-lift: 0 8px 24px rgba(79,70,229,0.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#0f172a;-webkit-font-smoothing:antialiased}
  /* App layout */
  #app{min-height:100vh;padding:28px;display:flex;gap:24px;align-items:stretch}
  .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-soft);padding:18px;display:flex;flex-direction:column;gap:12px;min-height:0;border:1px solid rgba(15,23,42,0.04)}
  .sidebar{width:300px;flex-shrink:0}
  .rightbar{width:360px;flex-shrink:0}
  .center{flex:1;display:flex;flex-direction:column;gap:16px;min-height:0}
  .panel.calendar{display:flex;flex-direction:column;gap:12px;flex:1;min-height:0}
  /* header */
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:var(--shadow-lift)}
  .brand h1{margin:0;font-size:15px;letter-spacing:0.06em;text-transform:uppercase}
  .muted{color:var(--muted);font-size:13px}
  /* list cards */
  .list{display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:6px;max-height:calc(100vh - 380px)}
  .card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(255,255,255,0.92));border:1px solid rgba(15,23,42,0.04);transition:transform .14s,box-shadow .14s}
  .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lift)}
  .icon{width:48px;height:48px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:inset 0 -6px 12px rgba(0,0,0,0.03)}
  .meta{flex:1}
  .title{font-weight:600;font-size:15px}
  .sub{font-size:12px;color:var(--muted);margin-top:6px}
  .progress{height:6px;background:#f1f5f9;border-radius:6px;margin-top:8px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2))}
  .actions{display:flex;flex-direction:column;gap:8px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:white;cursor:pointer;font-size:13px}
  .btn.primary{padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;border:none;box-shadow:var(--shadow-lift)}
  .small-muted{font-size:12px;color:var(--muted)}
  /* calendar */
  .cal-header{display:flex;align-items:center;justify-content:space-between}
  .cal-controls{display:flex;gap:8px;align-items:center}
  .cal-week{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:6px}
  .cal-day{padding:12px;border-radius:10px;text-align:center;font-size:14px;border:1px solid transparent;background:transparent;min-height:72px;display:flex;flex-direction:column;justify-content:space-between}
  .cal-day:hover{background:#fff}
  .cal-day.selected{background:linear-gradient(180deg,#eef2ff,#f5f7ff);border:1px solid rgba(99,102,241,0.18);box-shadow:0 8px 24px rgba(99,102,241,0.06)}
  .weekday{font-size:12px;color:var(--muted);text-align:center}
  .cal-dots{display:flex;gap:6px;justify-content:center;margin-top:8px}
  .dot{width:8px;height:8px;border-radius:8px}
  /* heatmap */
  .heat{display:flex;gap:8px;overflow-x:auto;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.5));align-items:center}
  .heat .sq{width:16px;height:16px;border-radius:4px;flex:0 0 auto}
  /* agenda */
  .agenda{display:flex;flex-direction:column;gap:12px;overflow:auto;max-height:calc(100vh - 260px);padding-right:6px}
  .agenda .card{justify-content:space-between}
  .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:36px;color:var(--muted)}
  .emoji{font-size:44px;margin-bottom:8px}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.28);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{width:100%;max-width:820px;background:var(--glass-2);border-radius:14px;padding:20px;border:1px solid rgba(15,23,42,0.06);box-shadow:var(--shadow-soft)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field{display:flex;flex-direction:column;gap:8px}
  .field input,.field select{padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:white;font-size:14px}
  .freq{display:flex;gap:8px}
  .freq button{width:40px;height:40px;border-radius:999px;border:1px solid rgba(15,23,42,0.06);background:white;cursor:pointer;font-weight:600}
  .freq button.active{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;border:none}
  /* focus */
  :focus{outline:3px solid rgba(99,102,241,0.12);outline-offset:2px;border-radius:10px}
  /* responsive */
  @media (max-width:1000px){
    .sidebar{display:none}
    .rightbar{display:none}
    #app{padding:16px}
  }
  /* micro animations */
  .fade{animation:fadeIn .18s ease-out both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
<div id="app">
  <!-- LEFT -->
  <aside class="panel sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="brand">
        <div class="logo">H</div>
        <div>
          <h1>Habit OS</h1>
          <div class="muted">Local Mode</div>
        </div>
      </div>
      <div class="small-muted">v1</div>
    </div>

    <div>
      <div class="small-muted" style="margin-top:8px">Backup ID</div>
      <div style="margin-top:8px;font-family:monospace;background:#fff;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.04)"><span id="backupId">user_xxx</span></div>
    </div>

    <div style="margin-top:10px" class="small-muted">All Items</div>
    <div id="listContainer" class="list"></div>

    <div style="margin-top:auto;display:flex;gap:10px">
      <button id="addItemBtn" class="btn primary" style="flex:1" data-action="open-editor">+ New Item</button>
      <button id="settingsBtn" class="btn" data-action="open-settings" title="Settings">âš™</button>
    </div>
  </aside>

  <!-- CENTER -->
  <main class="center">
    <div class="panel calendar">
      <div class="cal-header">
        <div>
          <div class="small-muted" id="monthLabel">February 2026</div>
          <div style="font-size:18px;font-weight:600" id="monthTitle"></div>
        </div>
        <div class="cal-controls">
          <button id="prevMonth" class="btn" data-action="prev-month" aria-label="Previous month">â—€</button>
          <button id="todayBtn" class="btn" data-action="today" aria-label="Today">Today</button>
          <button id="nextMonth" class="btn" data-action="next-month" aria-label="Next month">â–¶</button>
        </div>
      </div>

      <div id="calHead" class="cal-week"></div>

      <div id="calGrid" class="cal-grid" aria-label="Calendar grid"></div>

      <div class="small-muted">Consistency</div>
      <div id="heatmap" class="heat" aria-label="Consistency heatmap"></div>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="panel rightbar">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700" id="selectedDate">2026-02-07</div>
        <div class="small-muted">Your day</div>
      </div>
      <div class="small-muted">â€¢</div>
    </div>

    <div id="agendaList" class="agenda"></div>

    <button id="addRightBtn" class="btn primary" data-action="open-editor-right">+ Add Item</button>
  </aside>
</div>

<!-- Editor Modal -->
<div id="editorModal" class="modal-backdrop" style="display:none">
  <div class="modal fade" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">New Item</div>
      <div style="display:flex;gap:8px">
        <button id="closeModal" class="btn">Close</button>
      </div>
    </div>

    <form id="editorForm">
      <div class="form-grid">
        <div class="field">
          <label class="small-muted">Name</label>
          <input id="f_name" required />
        </div>
        <div class="field">
          <label class="small-muted">Type</label>
          <select id="f_type">
            <option value="habit">Routine</option>
            <option value="task">Task</option>
            <option value="event">Event</option>
            <option value="birthday">Birthday</option>
          </select>
        </div>

        <div class="field">
          <label class="small-muted">Category</label>
          <select id="f_category">
            <option>General</option><option>Health</option><option>Work</option><option>Social</option><option>Learning</option>
          </select>
        </div>

        <div class="field">
          <label class="small-muted">Difficulty</label>
          <select id="f_difficulty">
            <option>Easy</option><option>Medium</option><option>Heroic</option>
          </select>
        </div>

        <div class="field">
          <label class="small-muted">Monthly goal (optional)</label>
          <input id="f_goal" type="number" min="1" placeholder="e.g., 15" />
        </div>

        <div class="field">
          <label class="small-muted">Time (optional)</label>
          <input id="f_time" type="time" />
        </div>

        <div style="grid-column:1/3">
          <label class="small-muted">Frequency (for routines)</label>
          <div class="freq" id="freqBtns" style="margin-top:8px">
            <button type="button" data-day="0">S</button>
            <button type="button" data-day="1">M</button>
            <button type="button" data-day="2">T</button>
            <button type="button" data-day="3">W</button>
            <button type="button" data-day="4">T</button>
            <button type="button" data-day="5">F</button>
            <button type="button" data-day="6">S</button>
          </div>
        </div>

        <div class="field">
          <label class="small-muted">Date (for task/event/birthday)</label>
          <input id="f_date" type="date" />
        </div>

        <div class="field">
          <label class="small-muted">Use focus timer</label>
          <div style="margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px">
              <input id="f_timer" type="checkbox" />
              <span class="small-muted">Enable</span>
            </label>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
        <button type="button" id="cancelForm" class="btn">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Timer overlay -->
<div id="timerOverlay" class="modal-backdrop" style="display:none">
  <div class="modal" style="max-width:420px;text-align:center">
    <div class="small-muted">Focus Session</div>
    <div id="timerTime" style="font-size:36px;font-weight:700;margin:12px 0">25:00</div>
    <div id="timerLabel" class="small-muted" style="margin-bottom:12px"></div>
    <div style="display:flex;justify-content:center;gap:8px">
      <button id="cancelTimer" class="btn">Cancel</button>
    </div>
  </div>
</div>

<script>
/* Data + storage */
const LS_KEY = "habit_os_friendly_v1";
const todayStr = () => new Date().toISOString().slice(0,10);
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const dateObj = s => new Date(s + "T00:00:00");
const ymd = d => d.toISOString().slice(0,10);
const loadStore = () => JSON.parse(localStorage.getItem(LS_KEY) || "null") || {
  habits: [],
  completions: {},
  settings: { backupId: "user_" + Math.random().toString(36).slice(2,8), vacation:false },
  view: { selectedDate: todayStr(), monthOffset:0 }
};
let store = loadStore();
const save = () => localStorage.setItem(LS_KEY, JSON.stringify(store));

/* Helpers */
const el = id => document.getElementById(id);
const clamp = (v,min,max) => Math.max(min,Math.min(max,v));

/* Calendar helpers */
function monthDays(offset){
  const base = new Date(); base.setDate(1); base.setMonth(base.getMonth()+offset);
  const year = base.getFullYear(), month = base.getMonth();
  const first = new Date(year,month,1), startDow = first.getDay();
  const daysIn = new Date(year,month+1,0).getDate();
  const cells = [];
  for(let i=0;i<startDow;i++) cells.push(null);
  for(let d=1;d<=daysIn;d++) cells.push(new Date(year,month,d));
  return {cells,monthDate:first};
}
function fmtMonthYear(d){ return d.toLocaleDateString(undefined,{month:"long",year:"numeric"}); }

/* Due/completion */
function isDue(h,date){
  const d = dateObj(date), dow = d.getDay();
  if(h.type==="habit"){
    const freq = (h.frequency && h.frequency.length) ? h.frequency : [0,1,2,3,4,5,6];
    return !h.archived && freq.includes(dow);
  }
  if(h.type==="task") return !h.archived && h.targetDate===date;
  if(h.type==="event") return !h.archived && h.targetDate===date;
  if(h.type==="birthday"){
    if(!h.targetDate) return false;
    const td = dateObj(h.targetDate);
    return !h.archived && td.getDate()===d.getDate() && td.getMonth()===d.getMonth();
  }
  return false;
}
function dueItems(date){ return store.habits.filter(h=>isDue(h,date) && !h.archived); }
function addCompletion(date,id){ const c = store.completions[date]||[]; if(!c.includes(id)) c.push(id); store.completions[date]=c; save(); }
function removeCompletion(date,id){ const c = store.completions[date]||[]; store.completions[date]=c.filter(x=>x!==id); if(!store.completions[date].length) delete store.completions[date]; save(); }

/* Streaks & monthly */
function streakForHabit(h){
  let streak=0; let d = dateObj(todayStr());
  for(let i=0;i<365;i++){
    const ds = ymd(d);
    if(isDue(h,ds)){
      const done = (store.completions[ds]||[]).includes(h.id);
      if(done) streak++; else break;
    } else break;
    d.setDate(d.getDate()-1);
  }
  return streak;
}
function monthlyCount(h){
  if(!h.monthlyGoal) return 0;
  const now = dateObj(todayStr()), y = now.getFullYear(), m = now.getMonth();
  let count=0;
  Object.entries(store.completions).forEach(([date,ids])=>{
    const d = dateObj(date);
    if(d.getFullYear()===y && d.getMonth()===m && ids.includes(h.id)) count++;
  });
  return count;
}

/* Heatmap */
function last30(){
  const arr=[]; const base = dateObj(todayStr());
  for(let i=29;i>=0;i--){
    const d = new Date(base); d.setDate(d.getDate()-i);
    const ds = ymd(d);
    const due = store.habits.filter(h=>["habit","task"].includes(h.type) && isDue(h,ds));
    const done = (store.completions[ds]||[]).length;
    arr.push({date:ds,total:due.length,done});
  }
  return arr;
}

/* Render */
function render(){
  el("backupId").textContent = store.settings.backupId;
  const sel = store.view.selectedDate;
  el("selectedDate").textContent = sel;

  // left list
  const list = el("listContainer"); list.innerHTML = "";
  const items = store.habits.filter(h=>!h.archived).sort((a,b)=>a.name.localeCompare(b.name));
  items.forEach(h=>{
    const streak = streakForHabit(h);
    const monthly = monthlyCount(h);
    const pct = h.monthlyGoal ? clamp(Math.round((monthly/(h.monthlyGoal||1))*100),0,100) : 0;
    const node = document.createElement("div"); node.className = "card fade";
    node.innerHTML = `
      <div class="icon">${h.icon||"â€¢"}</div>
      <div class="meta">
        <div class="title">${h.name}</div>
        <div class="sub">${h.type} â€¢ ${h.category||"General"}</div>
        <div class="progress"><i style="width:${pct}%"></i></div>
        <div class="small-muted" style="margin-top:8px">Streak ${streak} â€¢ ${monthly}${h.monthlyGoal?` / ${h.monthlyGoal}`:""}</div>
      </div>
      <div class="actions">
        <button class="btn" data-edit="${h.id}" aria-label="Edit ${h.name}">Edit</button>
      </div>
    `;
    list.appendChild(node);
  });

  // calendar
  const month = monthDays(store.view.monthOffset);
  el("monthLabel").textContent = fmtMonthYear(month.monthDate);
  el("monthTitle").textContent = fmtMonthYear(month.monthDate);
  const week = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  el("calHead").innerHTML = week.map(w=>`<div class="weekday">${w}</div>`).join("");
  el("calGrid").innerHTML = month.cells.map(d=>{
    if(!d) return `<div></div>`;
    const ds = ymd(d);
    const isSel = ds===sel;
    const classes = isSel ? "cal-day selected" : "cal-day";
    const dots = store.habits.map(h=>{
      if(h.type==="event" && isDue(h,ds)) return `<div class="dot" style="background:#60a5fa"></div>`;
      if(h.type==="birthday" && isDue(h,ds)) return `<div class="dot" style="background:#fb7185"></div>`;
      return "";
    }).filter(Boolean).slice(0,3).join("");
    return `<button data-date="${ds}" class="${classes}" aria-label="Select ${ds}"><div style="font-weight:600">${d.getDate()}</div><div class="cal-dots">${dots}</div></button>`;
  }).join("");

  // heatmap
  el("heatmap").innerHTML = last30().map(h=>{
    const pct = h.total ? h.done / h.total : 0;
    const color = pct===1 ? "#6b46ff" : pct>=0.5 ? "#a78bfa" : pct>0 ? "#c7b3ff" : "#e6e9ef";
    return `<div class="sq" style="background:${color}" title="${h.date}"></div>`;
  }).join("");

  // agenda
  const agenda = el("agendaList"); agenda.innerHTML = "";
  const due = dueItems(sel);
  if(due.length===0){
    agenda.innerHTML = `<div class="empty"><div class="emoji">ðŸŽˆ</div><div class="small-muted">Nothing scheduled</div></div>`;
  } else {
    due.forEach(h=>{
      const done = (store.completions[sel]||[]).includes(h.id);
      const node = document.createElement("div"); node.className = "card fade";
      node.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          <div style="font-size:20px">${h.icon||"â€¢"}</div>
          <div>
            <div style="font-weight:700">${h.name}</div>
            <div class="small-muted">${h.type}${h.time?` â€¢ ${h.time}`:""}</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          ${h.useTimer && (h.type==="habit"||h.type==="task") ? `<button class="btn" data-timer="${h.id}">Start</button>` : ""}
          <button class="btn" data-toggle="${h.id}">${done ? "Done" : "Mark"}</button>
        </div>
      `;
      agenda.appendChild(node);
    });
  }
}

/* Delegated events and stable bindings */
(function setup(){
  const root = document.getElementById("app");
  root.addEventListener("click", (ev)=>{
    const btn = ev.target.closest("[data-date],[data-edit],[data-toggle],[data-timer],[data-action]");
    if(!btn) return;
    if(btn.hasAttribute("data-date")){
      const d = btn.getAttribute("data-date");
      store.view.selectedDate = d; save(); render(); return;
    }
    if(btn.hasAttribute("data-edit")){
      const id = btn.getAttribute("data-edit"); const item = store.habits.find(x=>x.id===id);
      if(item) openEditor(item); return;
    }
    if(btn.hasAttribute("data-toggle")){
      const id = btn.getAttribute("data-toggle"); const date = store.view.selectedDate;
      const done = (store.completions[date]||[]).includes(id);
      if(done) removeCompletion(date,id); else addCompletion(date,id); render(); return;
    }
    if(btn.hasAttribute("data-timer")){
      const id = btn.getAttribute("data-timer"); startTimer(id, store.view.selectedDate); return;
    }
    if(btn.hasAttribute("data-action")){
      const action = btn.getAttribute("data-action");
      if(action==="prev-month"){ store.view.monthOffset--; save(); render(); }
      if(action==="next-month"){ store.view.monthOffset++; save(); render(); }
      if(action==="today"){ store.view.selectedDate = todayStr(); store.view.monthOffset = 0; save(); render(); }
      if(action==="open-editor"||action==="open-editor-right"){ openEditor(); }
      if(action==="open-settings"){ alert("Settings coming soon"); }
      return;
    }
  });

  // modal static bindings
  const modal = document.getElementById("editorModal");
  document.getElementById("closeModal").onclick = ()=>{ modal.style.display="none"; modal.dataset.editId=""; };
  document.getElementById("cancelForm").onclick = ()=>{ modal.style.display="none"; modal.dataset.editId=""; };
  document.querySelectorAll("#freqBtns button").forEach(b=>b.onclick = ()=>b.classList.toggle("active"));

  // form submit
  document.getElementById("editorForm").onsubmit = (e)=>{
    e.preventDefault();
    const modalEl = document.getElementById("editorModal");
    const id = modalEl.dataset.editId || uid();
    const name = document.getElementById("f_name").value.trim() || "Untitled";
    const type = document.getElementById("f_type").value;
    const category = document.getElementById("f_category").value;
    const difficulty = document.getElementById("f_difficulty").value;
    const monthlyGoal = document.getElementById("f_goal").value ? parseInt(document.getElementById("f_goal").value) : null;
    const time = document.getElementById("f_time").value || "";
    const targetDate = document.getElementById("f_date").value || todayStr();
    const useTimer = document.getElementById("f_timer").checked;
    const freq = Array.from(document.querySelectorAll("#freqBtns button")).filter(b=>b.classList.contains("active")).map(b=>parseInt(b.getAttribute("data-day")));
    const item = { id, name, type, category, difficulty, monthlyGoal, time, targetDate, useTimer, frequency: freq.length?freq:[0,1,2,3,4,5,6], archived:false, order: store.habits.length, icon:"â€¢" };
    const existing = store.habits.find(x=>x.id===id);
    if(existing){ const idx = store.habits.findIndex(x=>x.id===id); store.habits[idx] = item; } else store.habits.push(item);
    if(item.type==="task"||item.type==="event"||item.type==="birthday"){
      store.view.selectedDate = item.targetDate;
      const t = dateObj(item.targetDate), now = new Date();
      const monthDiff = (t.getFullYear()-now.getFullYear())*12 + (t.getMonth()-now.getMonth());
      store.view.monthOffset = monthDiff;
    }
    save(); modalEl.style.display="none"; modalEl.dataset.editId=""; render();
  };

  // timer cancel
  document.getElementById("cancelTimer").onclick = ()=>{
    if(window._timerId){ clearInterval(window._timerId); window._timerId = null; }
    document.getElementById("timerOverlay").style.display = "none";
  };
})();

/* Editor helper */
function openEditor(h=null){
  const modal = document.getElementById("editorModal");
  const f = h ? h : { id: uid(), name:"", type:"habit", category:"General", difficulty:"Easy", monthlyGoal:null, time:"", frequency:[1,2,3,4,5], targetDate:todayStr(), useTimer:false, icon:"â€¢" };
  document.getElementById("f_name").value = f.name || "";
  document.getElementById("f_type").value = f.type || "habit";
  document.getElementById("f_category").value = f.category || "General";
  document.getElementById("f_difficulty").value = f.difficulty || "Easy";
  document.getElementById("f_goal").value = f.monthlyGoal || "";
  document.getElementById("f_time").value = f.time || "";
  document.getElementById("f_date").value = f.targetDate || "";
  document.getElementById("f_timer").checked = !!f.useTimer;
  document.querySelectorAll("#freqBtns button").forEach(btn=>{
    const day = parseInt(btn.getAttribute("data-day"));
    const active = (f.frequency || [0,1,2,3,4,5,6]).includes(day);
    btn.classList.toggle("active", active);
  });
  modal.style.display = "flex";
  modal.dataset.editId = h ? h.id : "";
}

/* Timer */
function startTimer(id,date){
  const h = store.habits.find(x=>x.id===id); if(!h) return;
  window._timerId && clearInterval(window._timerId);
  let remaining = 25*60;
  document.getElementById("timerLabel").textContent = h.name;
  document.getElementById("timerTime").textContent = "25:00";
  document.getElementById("timerOverlay").style.display = "flex";
  window._timerId = setInterval(()=>{
    remaining--;
    const m = String(Math.floor(remaining/60)).padStart(2,"0");
    const s = String(remaining%60).padStart(2,"0");
    document.getElementById("timerTime").textContent = `${m}:${s}`;
    if(remaining<=0){ clearInterval(window._timerId); window._timerId = null; addCompletion(date,id); document.getElementById("timerOverlay").style.display = "none"; render(); }
  },1000);
}

/* Controls */
document.getElementById("prevMonth").onclick = ()=>{ store.view.monthOffset--; save(); render(); };
document.getElementById("nextMonth").onclick = ()=>{ store.view.monthOffset++; save(); render(); };
document.getElementById("todayBtn").onclick = ()=>{ store.view.selectedDate = todayStr(); store.view.monthOffset = 0; save(); render(); };

/* Seed */
if(!store.habits.length){
  store.habits.push({ id: uid(), name: "Daily Planning", type: "habit", category:"Work", difficulty:"Easy", monthlyGoal:20, time:"", frequency:[1,2,3,4,5], useTimer:true, archived:false, order:0, icon:"ðŸ§ " });
  save();
}
render();
</script>
</body>
</html>
