<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Habit OS â€” Light Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            border: "rgba(0,0,0,0.06)",
            softbg: "#f7f8fa"
          },
          boxShadow: {
            soft: "0 8px 30px rgba(16,24,40,0.06)"
          }
        }
      }
    };
  </script>
  <style>
    body { background: #f5f6f8; color: #0f172a; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .glass { background: rgba(255,255,255,0.72); backdrop-filter: blur(8px); }
    .border-soft { border: 1px solid rgba(15,23,42,0.06); }
    .shadow-soft { box-shadow: 0 8px 30px rgba(16,24,40,0.06); }
    /* small helper to keep heatmap squares consistent */
    .heat-square { width: 12px; height: 12px; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="app" class="w-full max-w-[1600px] mx-auto px-6 py-6"></div>

  <!-- Timer overlay -->
  <div id="timerOverlay" class="fixed inset-0 hidden items-center justify-center bg-black/30 z-50">
    <div class="glass border-soft rounded-2xl shadow-soft px-8 py-6 flex flex-col items-center gap-4 max-w-sm w-full mx-4">
      <div class="text-xs uppercase tracking-wide text-slate-500">Focus Session</div>
      <div id="timerTime" class="text-4xl font-semibold tabular-nums">25:00</div>
      <div id="timerLabel" class="text-base text-slate-700"></div>
      <div class="w-full flex justify-center">
        <button id="timerCancel" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 text-sm">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* -------------------------
   Storage + Utilities
   ------------------------- */
const LS_KEY = "habit_os_v1_lightplanner";
const todayStr = () => new Date().toISOString().slice(0,10);
const clone = o => JSON.parse(JSON.stringify(o));
const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; } catch { return null; } };
const emptyStore = () => ({
  habits: [],
  completions: {},
  settings: { theme: "light", vacationMode: false, backupId: "user_" + Math.random().toString(36).slice(2,8) },
  view: { selectedDate: todayStr(), monthOffset: 0, manualSort: false }
});
let store = load() || emptyStore();
const save = () => localStorage.setItem(LS_KEY, JSON.stringify(store));
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const dateObj = s => new Date(s + "T00:00:00");
const ymd = d => d.toISOString().slice(0,10);
const fmtMonthYear = d => d.toLocaleDateString(undefined,{month:"long",year:"numeric"});

/* -------------------------
   Completions + Due logic
   ------------------------- */
const addCompletion = (date,id) => {
  const c = store.completions[date] || [];
  if (!c.includes(id)) c.push(id);
  store.completions[date] = c;
};
const removeCompletion = (date,id) => {
  const c = store.completions[date] || [];
  store.completions[date] = c.filter(x => x !== id);
  if (!store.completions[date].length) delete store.completions[date];
};

const isDue = (h,date) => {
  const d = dateObj(date);
  const dow = d.getDay();
  if (h.type === "habit") {
    const freq = (h.frequency && h.frequency.length) ? h.frequency : [0,1,2,3,4,5,6];
    return !h.archived && freq.includes(dow);
  }
  if (h.type === "task") return !h.archived && h.targetDate === date;
  if (h.type === "event") return !h.archived && h.targetDate === date;
  if (h.type === "birthday") {
    if (!h.targetDate) return false;
    const td = dateObj(h.targetDate);
    return !h.archived && td.getDate() === d.getDate() && td.getMonth() === d.getMonth();
  }
  return false;
};

const dueItems = date => store.habits.filter(h => isDue(h,date) && !h.archived);

/* -------------------------
   Calendar / Heatmap
   ------------------------- */
const dayStats = date => {
  const due = store.habits.filter(h => ["habit","task"].includes(h.type) && isDue(h,date));
  const done = store.completions[date] || [];
  return { total: due.length, done: done.length };
};

const last30 = () => {
  const arr = [];
  const base = dateObj(todayStr());
  for (let i = 29; i >= 0; i--) {
    const d = new Date(base);
    d.setDate(d.getDate() - i);
    const ds = ymd(d);
    const st = dayStats(ds);
    arr.push({ date: ds, ...st });
  }
  return arr;
};

const monthDays = offset => {
  const base = new Date();
  base.setDate(1);
  base.setMonth(base.getMonth() + offset);
  const year = base.getFullYear();
  const month = base.getMonth();
  const first = new Date(year, month, 1);
  const startDow = first.getDay();
  const daysIn = new Date(year, month + 1, 0).getDate();
  const cells = [];
  for (let i = 0; i < startDow; i++) cells.push(null);
  for (let d = 1; d <= daysIn; d++) cells.push(new Date(year, month, d));
  return { cells, monthDate: first };
};

/* -------------------------
   Editor (simple prompt)
   ------------------------- */
const openEditor = (h) => {
  const base = h ? clone(h) : {
    id: uid(),
    name: "",
    type: "habit",
    icon: "â€¢",
    targetDate: todayStr(),
    frequency: [1,2,3,4,5],
    monthlyGoal: null,
    useTimer: false,
    archived: false,
    order: store.habits.length
  };

  const name = prompt("Name", base.name);
  if (name === null) return;
  base.name = name.trim() || "Untitled";

  const type = prompt("Type: habit/task/event/birthday", base.type) || base.type;
  base.type = ["habit","task","event","birthday"].includes(type) ? type : "habit";

  const icon = prompt("Emoji icon", base.icon) || base.icon;
  base.icon = icon;

  if (["task","event","birthday"].includes(base.type)) {
    const td = prompt("Date (YYYY-MM-DD)", base.targetDate) || base.targetDate;
    base.targetDate = td;
  } else {
    const freqStr = prompt("Frequency days (0-6 comma, blank=daily)", base.frequency.join(",")) || "";
    base.frequency = freqStr
      ? freqStr.split(",").map(x => parseInt(x.trim())).filter(x => x >= 0 && x <= 6)
      : [0,1,2,3,4,5,6];
  }

  const goalStr = prompt("Monthly goal (blank=none)", base.monthlyGoal ?? "");
  base.monthlyGoal = goalStr ? (parseInt(goalStr) || null) : null;

  base.useTimer = confirm("Use focus timer? OK = yes");

  if (h) {
    const idx = store.habits.findIndex(x => x.id === h.id);
    store.habits[idx] = base;
  } else {
    store.habits.push(base);
  }
  store.habits.forEach((hh,i) => hh.order = i);
  save();
  render();
};

/* -------------------------
   Timer (simple)
   ------------------------- */
let timerId = null;
let timerRemaining = 0;
let timerHabitId = null;
let timerDate = null;

const startTimer = (id, date) => {
  const h = store.habits.find(x => x.id === id);
  if (!h) return;
  timerHabitId = id;
  timerDate = date;
  timerRemaining = 25 * 60;
  document.getElementById("timerOverlay").classList.remove("hidden");
  document.getElementById("timerLabel").textContent = `${h.icon} ${h.name}`;
  updateTimerDisplay();
  if (timerId) clearInterval(timerId);
  timerId = setInterval(() => {
    timerRemaining--;
    if (timerRemaining <= 0) {
      clearInterval(timerId);
      timerId = null;
      addCompletion(timerDate, timerHabitId);
      save();
      render();
      closeTimer();
    } else updateTimerDisplay();
  }, 1000);
};

const updateTimerDisplay = () => {
  const m = Math.floor(timerRemaining / 60).toString().padStart(2,"0");
  const s = (timerRemaining % 60).toString().padStart(2,"0");
  const el = document.getElementById("timerTime");
  if (el) el.textContent = `${m}:${s}`;
};

const closeTimer = () => {
  document.getElementById("timerOverlay").classList.add("hidden");
  if (timerId) { clearInterval(timerId); timerId = null; }
};
document.getElementById("timerCancel").onclick = closeTimer;

/* -------------------------
   Export / Import / Helpers
   ------------------------- */
const exportJson = () => {
  const blob = new Blob([JSON.stringify(store)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "habit_os_backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
};

const importJson = () => {
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = ".json";
  inp.onchange = e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        store = data;
        save();
        render();
      } catch {
        alert("Invalid file");
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

/* -------------------------
   Render
   ------------------------- */
const render = () => {
  const app = document.getElementById("app");
  const sel = store.view.selectedDate;
  const month = monthDays(store.view.monthOffset);
  const days = month.cells;
  const monthLabel = fmtMonthYear(month.monthDate);
  const items = dueItems(sel);

  // Sidebar list
  const sidebarList = store.habits
    .filter(h => !h.archived)
    .sort((a,b) => store.view.manualSort ? a.order - b.order : a.name.localeCompare(b.name))
    .map(h => `
      <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-gray-100 flex items-center gap-3" data-edit="${h.id}">
        <div class="w-8 h-8 rounded-lg bg-white border border-gray-100 flex items-center justify-center text-lg">${h.icon}</div>
        <div class="text-sm">${h.name}</div>
      </button>
    `).join("");

  // Calendar header
  const week = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const calHead = week.map(w => `<div class="text-xs text-gray-500 text-center">${w}</div>`).join("");

  // Calendar cells
  const calCells = days.map(d => {
    if (!d) return `<div></div>`;
    const ds = ymd(d);
    const isSel = ds === sel;
    const classes = isSel ? "bg-indigo-50 border border-indigo-200" : "hover:bg-gray-100";
    return `<button data-date="${ds}" class="rounded-xl px-2 py-2 text-sm text-center ${classes}">${d.getDate()}</button>`;
  }).join("");

  // Heatmap (horizontal strip)
  const heat = last30().map(d => {
    const pct = d.total ? d.done / d.total : 0;
    const color =
      pct === 1 ? "bg-indigo-600" :
      pct >= 0.5 ? "bg-indigo-400" :
      pct > 0 ? "bg-indigo-200" :
      "bg-gray-200";
    return `<div class="heat-square ${color}" title="${d.date}"></div>`;
  }).join("");

  // Agenda / day view
  const agenda = items.length ? items.map(h => {
    const done = (store.completions[sel] || []).includes(h.id);
    return `
      <div class="glass border-soft rounded-xl px-4 py-3 shadow-soft flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-xl">${h.icon}</div>
          <div>
            <div class="text-sm font-medium">${h.name}</div>
            <div class="text-xs text-gray-500">${h.type}</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          ${h.useTimer && ["habit","task"].includes(h.type) ? `<button data-timer="${h.id}" class="px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-100 text-xs">Start</button>` : ""}
          <button data-toggle="${h.id}" class="px-2 py-1 rounded-md border border-gray-200 text-xs ${done ? "bg-emerald-50" : ""}">${done ? "Done" : "Mark"}</button>
        </div>
      </div>
    `;
  }).join("") : `
    <div class="flex flex-col items-center justify-center text-center py-12 text-gray-400">
      <div class="text-5xl mb-3">ðŸŽˆ</div>
      <div class="text-sm">Nothing scheduled</div>
    </div>
  `;

  // Build layout
  app.innerHTML = `
    <div class="grid grid-cols-1 md:[grid-template-columns:260px_1fr_320px] gap-6">

      <!-- LEFT -->
      <aside class="glass border-soft rounded-2xl shadow-soft p-4 flex flex-col gap-4">
        <div>
          <div class="text-lg font-semibold">Habit OS</div>
          <div class="text-xs text-gray-500 mt-1">Local Mode</div>
        </div>

        <div class="text-xs text-gray-500">Backup ID</div>
        <div class="text-sm font-mono bg-white px-3 py-2 rounded-xl border border-gray-100">${store.settings.backupId}</div>

        <div class="mt-3 text-xs text-gray-500">All Items</div>
        <div class="flex flex-col gap-1 max-h-[420px] overflow-y-auto pr-1">${sidebarList}</div>

        <button id="addLeft" class="mt-auto px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500">+ Add Item</button>
      </aside>

      <!-- CENTER -->
      <main class="flex flex-col gap-4">
        <div class="glass border-soft rounded-2xl shadow-soft p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm font-medium">${monthLabel}</div>
            <div class="flex items-center gap-2">
              <button id="prevMonth" class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-100 text-xs">â—€</button>
              <button id="todayBtn" class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-100 text-xs">Today</button>
              <button id="nextMonth" class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-100 text-xs">â–¶</button>
            </div>
          </div>

          <div class="grid grid-cols-7 gap-2 mb-2">${calHead}</div>
          <div class="grid grid-cols-7 gap-2">${calCells}</div>
        </div>

        <div class="glass border-soft rounded-2xl shadow-soft p-4">
          <div class="text-xs text-gray-500 mb-2">Consistency</div>
          <div class="flex gap-1 overflow-x-auto py-1">${heat}</div>
        </div>
      </main>

      <!-- RIGHT -->
      <aside class="glass border-soft rounded-2xl shadow-soft p-4 flex flex-col gap-4">
        <div>
          <div class="text-lg font-semibold">${sel}</div>
          <div class="text-xs text-gray-500 mt-1">Your day</div>
        </div>

        <div class="flex flex-col gap-3 max-h-[420px] overflow-y-auto pr-1">${agenda}</div>

        <button id="addRight" class="mt-auto px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500">+ Add Item</button>
      </aside>

    </div>

    <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
      <div>Light planner â€¢ Local storage</div>
      <div class="flex items-center gap-2">
        <button id="exportBtn" class="px-3 py-1 rounded-md border border-gray-200 hover:bg-gray-100">Export</button>
        <button id="importBtn" class="px-3 py-1 rounded-md border border-gray-200 hover:bg-gray-100">Import</button>
      </div>
    </div>
  `;

  // Bindings
  document.getElementById("addLeft").onclick = () => openEditor();
  document.getElementById("addRight").onclick = () => openEditor();
  document.getElementById("exportBtn").onclick = exportJson;
  document.getElementById("importBtn").onclick = importJson;
  document.getElementById("prevMonth").onclick = () => { store.view.monthOffset--; save(); render(); };
  document.getElementById("nextMonth").onclick = () => { store.view.monthOffset++; save(); render(); };
  document.getElementById("todayBtn").onclick = () => { store.view.selectedDate = todayStr(); store.view.monthOffset = 0; save(); render(); };

  document.querySelectorAll("[data-edit]").forEach(el => {
    el.onclick = (e) => {
      const id = el.getAttribute("data-edit");
      const h = store.habits.find(x => x.id === id);
      openEditor(h);
    };
  });

  document.querySelectorAll("[data-date]").forEach(el => {
    el.onclick = () => {
      const d = el.getAttribute("data-date");
      if (!d) return;
      store.view.selectedDate = d;
      save();
      render();
    };
  });

  document.querySelectorAll("[data-toggle]").forEach(el => {
    el.onclick = (e) => {
      const id = el.getAttribute("data-toggle");
      const date = store.view.selectedDate;
      const done = (store.completions[date] || []).includes(id);
      if (done) removeCompletion(date, id);
      else addCompletion(date, id);
      save();
      render();
    };
  });

  document.querySelectorAll("[data-timer]").forEach(el => {
    el.onclick = (e) => {
      const id = el.getAttribute("data-timer");
      startTimer(id, store.view.selectedDate);
    };
  });
};

/* -------------------------
   Seed a simple habit if empty
   ------------------------- */
if (!store.habits.length) {
  store.habits.push({
    id: uid(),
    name: "Daily Planning",
    type: "habit",
    icon: "ðŸ§ ",
    targetDate: todayStr(),
    frequency: [1,2,3,4,5],
    monthlyGoal: 20,
    useTimer: true,
    archived: false,
    order: 0
  });
  save();
}

/* Initial render */
render();
</script>
</body>
</html>
