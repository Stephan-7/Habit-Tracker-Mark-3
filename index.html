<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit OS - Full Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569', 200: '#e2e8f0' }
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-900 transition-colors duration-300 overflow-hidden text-slate-800 dark:text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (Full Set) ---
        const Icons = {
            Check: (p) => <svg {...p} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Plus: (p) => <svg {...p} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: (p) => <svg {...p} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Edit: (p) => <svg {...p} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>,
            Play: (p) => <svg {...p} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>,
            Pause: (p) => <svg {...p} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>,
            Clock: (p) => <svg {...p} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            ChevronLeft: (p) => <svg {...p} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: (p) => <svg {...p} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Inbox: (p) => <svg {...p} width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>,
            Calendar: (p) => <svg {...p} width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        };

        // --- SUB-COMPONENT: FOCUS TIMER ---
        const FocusTimer = ({ habit, onClose, onComplete }) => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            
            useEffect(() => {
                let interval;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                } else if (timeLeft === 0) {
                    onComplete();
                    onClose();
                    // Simple beep
                    const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                    audio.play();
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft]);

            const fmt = (s) => {
                const m = Math.floor(s / 60).toString().padStart(2,'0');
                const sec = (s % 60).toString().padStart(2,'0');
                return `${m}:${sec}`;
            };

            return (
                <div className="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center backdrop-blur-sm">
                    <div className="text-center text-white">
                        <div className="text-6xl mb-4">{habit.icon}</div>
                        <h2 className="text-2xl font-bold mb-8">{habit.name}</h2>
                        <div className="text-9xl font-mono font-black mb-12 tracking-tighter">{fmt(timeLeft)}</div>
                        <div className="flex gap-4 justify-center">
                            <button onClick={() => setIsActive(!isActive)} className="px-8 py-4 bg-white text-indigo-900 rounded-full font-bold text-xl hover:scale-105 transition-transform">
                                {isActive ? 'PAUSE' : 'START'}
                            </button>
                            <button onClick={onClose} className="px-8 py-4 border-2 border-white/20 text-white rounded-full font-bold text-xl hover:bg-white/10">
                                STOP
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: MODAL WITH SUBTASKS ---
        const HabitModal = ({ isOpen, onClose, onSave, onDelete, initialData }) => {
            if (!isOpen) return null;
            
            // Subtasks State
            const [subtasks, setSubtasks] = useState(initialData?.subtasks || []);

            const handleSubmit = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                
                // Collect valid subtasks
                const validSubtasks = subtasks.filter(st => st.text.trim() !== "");

                onSave({
                    id: initialData?.id,
                    name: fd.get('name'),
                    icon: fd.get('icon'),
                    type: fd.get('type'),
                    targetDate: fd.get('targetDate'),
                    time: fd.get('time'),
                    frequency: initialData?.frequency || [0,1,2,3,4,5,6], // Simple default for now
                    useTimer: fd.get('useTimer') === 'on',
                    subtasks: validSubtasks
                });
            };

            const addSubtask = () => setSubtasks([...subtasks, { text: '', completed: false }]);
            const updateSubtask = (idx, val) => {
                const newSt = [...subtasks];
                newSt[idx].text = val;
                setSubtasks(newSt);
            };

            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-dark-800 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-in">
                        <div className="p-6">
                            <h2 className="text-xl font-bold mb-4">{initialData ? 'Edit Item' : 'New Item'}</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="flex gap-2">
                                    <input name="icon" defaultValue={initialData?.icon || 'ðŸ“'} className="w-14 text-center text-xl p-3 bg-slate-100 dark:bg-dark-700 rounded-xl" />
                                    <input name="name" defaultValue={initialData?.name} placeholder="Item Name" className="flex-1 p-3 bg-slate-100 dark:bg-dark-700 rounded-xl font-bold" required />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <select name="type" defaultValue={initialData?.type || 'habit'} className="p-3 bg-slate-100 dark:bg-dark-700 rounded-xl">
                                        <option value="habit">Habit (Recurring)</option>
                                        <option value="task">Task (One-off)</option>
                                        <option value="event">Event</option>
                                    </select>
                                    <input type="time" name="time" defaultValue={initialData?.time} className="p-3 bg-slate-100 dark:bg-dark-700 rounded-xl" />
                                </div>
                                
                                <input type="date" name="targetDate" defaultValue={initialData?.targetDate} className="w-full p-3 bg-slate-100 dark:bg-dark-700 rounded-xl" />
                                
                                <div className="flex items-center gap-2 p-3 bg-slate-50 dark:bg-dark-700 rounded-xl">
                                    <input type="checkbox" name="useTimer" defaultChecked={initialData?.useTimer} id="timer" />
                                    <label htmlFor="timer" className="text-sm font-medium">Enable Focus Timer</label>
                                </div>

                                {/* SUBTASKS SECTION */}
                                <div className="border-t border-slate-100 dark:border-dark-700 pt-4">
                                    <label className="text-xs font-bold uppercase text-slate-400 mb-2 block">Checklist</label>
                                    <div className="space-y-2 max-h-32 overflow-y-auto">
                                        {subtasks.map((st, i) => (
                                            <input 
                                                key={i} 
                                                value={st.text} 
                                                onChange={(e) => updateSubtask(i, e.target.value)}
                                                placeholder="Step description..."
                                                className="w-full p-2 text-sm bg-slate-50 dark:bg-dark-900 rounded-lg border border-transparent focus:border-indigo-500"
                                            />
                                        ))}
                                        <button type="button" onClick={addSubtask} className="text-xs text-indigo-500 font-bold hover:underline">+ Add Step</button>
                                    </div>
                                </div>

                                <div className="flex gap-3 pt-4">
                                    {initialData && (
                                        <button type="button" onClick={() => onDelete(initialData.id)} className="p-3 text-red-500 bg-red-50 dark:bg-red-900/20 rounded-xl hover:bg-red-100">
                                            <Icons.Trash />
                                        </button>
                                    )}
                                    <button type="button" onClick={onClose} className="flex-1 p-3 text-slate-500 font-bold">Cancel</button>
                                    <button type="submit" className="flex-1 p-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APPLICATION ---
        function App() {
            // State
            const [habits, setHabits] = useState([]);
            const [completions, setCompletions] = useState({});
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [activeFocusHabit, setActiveFocusHabit] = useState(null);
            const [centerView, setCenterView] = useState('calendar'); // 'calendar' | 'inbox'
            
            // Initialization
            useEffect(() => {
                const savedH = JSON.parse(localStorage.getItem('habits_full') || '[]');
                const savedC = JSON.parse(localStorage.getItem('completions_full') || '{}');
                setHabits(savedH);
                setCompletions(savedC);
                if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            }, []);

            const saveData = (h, c) => {
                setHabits(h);
                setCompletions(c);
                localStorage.setItem('habits_full', JSON.stringify(h));
                localStorage.setItem('completions_full', JSON.stringify(c));
            };

            // Helpers
            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const days = [];
                
                // Padding for start
                for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
                // Days
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const d = new Date(year, month, i);
                    days.push(d.toISOString().split('T')[0]);
                }
                return days;
            };

            const getDailyStats = (date) => {
                const dayOfWeek = new Date(date).getDay();
                const due = habits.filter(h => {
                    if (h.archived || h.isInbox) return false;
                    if (h.type === 'event' || h.type === 'birthday') return false;
                    if (h.type === 'task') return h.targetDate === date;
                    return h.frequency.includes(dayOfWeek);
                });
                if (due.length === 0) return 0;
                const done = due.filter(h => completions[date]?.includes(h.id)).length;
                return Math.round((done / due.length) * 100);
            };

            // Actions
            const toggleComplete = (id, date) => {
                const current = completions[date] || [];
                const updated = current.includes(id) 
                    ? current.filter(x => x !== id) 
                    : [...current, id];
                
                const newComps = { ...completions, [date]: updated };
                saveData(habits, newComps);

                if (!current.includes(id) && getDailyStats(date) >= 99) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }
            };

            const toggleSubtask = (habitId, subIndex) => {
                const newHabits = habits.map(h => {
                    if (h.id === habitId) {
                        const newSub = [...(h.subtasks || [])];
                        newSub[subIndex].completed = !newSub[subIndex].completed;
                        return { ...h, subtasks: newSub };
                    }
                    return h;
                });
                saveData(newHabits, completions);
            };

            const handleSave = (item) => {
                const id = item.id || Date.now().toString();
                // INBOX LOGIC: If task & no date, it is Inbox
                const isInbox = item.type === 'task' && !item.targetDate;
                
                const finalItem = { ...item, id, isInbox, subtasks: item.subtasks || [] };
                
                const newHabits = item.id 
                    ? habits.map(h => h.id === id ? finalItem : h) 
                    : [...habits, finalItem];
                
                saveData(newHabits, completions);
                setIsModalOpen(false);
                setEditingItem(null);
            };

            const deleteItem = (id) => {
                const newHabits = habits.filter(h => h.id !== id);
                saveData(newHabits, completions);
                setIsModalOpen(false);
            };

            // Rendering Logic
            const days = getDaysInMonth(currentMonth);
            const monthName = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });

            return (
                <div className="flex h-screen w-full">
                    {/* LEFT SIDEBAR: REGISTRY */}
                    <aside className="w-72 bg-white dark:bg-dark-800 border-r border-slate-200 dark:border-dark-700 flex flex-col z-20 shadow-xl">
                        <div className="p-6">
                            <h1 className="text-2xl font-black text-indigo-600 dark:text-indigo-400 tracking-tight mb-8">HABIT OS</h1>
                            
                            {/* NEW: View Switcher */}
                            <div className="bg-slate-100 dark:bg-dark-700 p-1 rounded-xl flex mb-6">
                                <button onClick={() => setCenterView('calendar')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${centerView === 'calendar' ? 'bg-white dark:bg-dark-600 shadow text-indigo-600' : 'text-slate-500'}`}>Calendar</button>
                                <button onClick={() => setCenterView('inbox')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${centerView === 'inbox' ? 'bg-white dark:bg-dark-600 shadow text-indigo-600' : 'text-slate-500'}`}>
                                    Inbox ({habits.filter(h => h.isInbox).length})
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto px-6 space-y-6 scrollbar-hide">
                            {/* Habits List */}
                            <div>
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Habits</h3>
                                <div className="space-y-1">
                                    {habits.filter(h => h.type === 'habit' && !h.archived).map(h => (
                                        <div key={h.id} className="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-dark-700 group cursor-pointer" onClick={() => {setEditingItem(h); setIsModalOpen(true);}}>
                                            <div className="flex items-center gap-3">
                                                <span>{h.icon}</span>
                                                <span className="font-medium text-sm">{h.name}</span>
                                            </div>
                                            <Icons.Edit className="opacity-0 group-hover:opacity-100 text-slate-300" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Tasks List */}
                             <div>
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Upcoming Tasks</h3>
                                <div className="space-y-1">
                                    {habits.filter(h => h.type === 'task' && !h.isInbox && !h.archived).map(h => (
                                        <div key={h.id} className="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-dark-700 group cursor-pointer" onClick={() => {setEditingItem(h); setIsModalOpen(true);}}>
                                            <div className="flex items-center gap-3">
                                                <span>{h.icon}</span>
                                                <div className="flex flex-col">
                                                    <span className="font-medium text-sm">{h.name}</span>
                                                    <span className="text-[10px] text-slate-400">{h.targetDate}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t border-slate-200 dark:border-dark-700">
                             <button onClick={() => {setEditingItem(null); setIsModalOpen(true);}} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition-transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                <Icons.Plus /> New Item
                            </button>
                        </div>
                    </aside>

                    {/* CENTER PANE: CALENDAR OR INBOX */}
                    <main className="flex-1 bg-slate-50 dark:bg-dark-900 flex flex-col overflow-hidden relative">
                        {centerView === 'calendar' ? (
                            <>
                                {/* Calendar Header */}
                                <header className="p-8 pb-0 flex justify-between items-end z-10">
                                    <div>
                                        <h2 className="text-3xl font-black text-slate-800 dark:text-white">{monthName}</h2>
                                        <p className="text-slate-400 font-medium">Overview</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1)))} className="p-2 hover:bg-white dark:hover:bg-dark-700 rounded-full"><Icons.ChevronLeft /></button>
                                        <button onClick={() => setCurrentMonth(new Date())} className="px-4 py-2 bg-white dark:bg-dark-700 rounded-lg text-sm font-bold shadow-sm">Today</button>
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1)))} className="p-2 hover:bg-white dark:hover:bg-dark-700 rounded-full"><Icons.ChevronRight /></button>
                                    </div>
                                </header>

                                {/* Calendar Grid */}
                                <div className="flex-1 p-8 overflow-y-auto">
                                    <div className="grid grid-cols-7 mb-4 text-center">
                                        {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => <div key={d} className="text-xs font-bold text-slate-400 uppercase">{d}</div>)}
                                    </div>
                                    <div className="grid grid-cols-7 grid-rows-5 gap-2 h-[calc(100%-200px)]">
                                        {days.map((date, i) => {
                                            if (!date) return <div key={i} className="bg-transparent"></div>;
                                            const isSelected = date === selectedDate;
                                            const score = getDailyStats(date);
                                            const isToday = date === new Date().toISOString().split('T')[0];
                                            
                                            return (
                                                <div 
                                                    key={date} 
                                                    onClick={() => setSelectedDate(date)}
                                                    className={`
                                                        relative p-2 rounded-2xl border transition-all cursor-pointer flex flex-col justify-between
                                                        ${isSelected 
                                                            ? 'border-indigo-500 ring-2 ring-indigo-500/20 bg-white dark:bg-dark-800' 
                                                            : 'border-slate-200 dark:border-dark-700 bg-white dark:bg-dark-800 hover:border-indigo-300'}
                                                    `}
                                                >
                                                    <div className="flex justify-between items-start">
                                                        <span className={`text-sm font-bold ${isToday ? 'bg-indigo-600 text-white px-2 rounded-full' : 'text-slate-500'}`}>
                                                            {date.split('-')[2]}
                                                        </span>
                                                        {score > 0 && (
                                                            <div className={`text-[10px] font-bold px-1.5 rounded-md ${score === 100 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}`}>
                                                                {score}%
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Mini Dots for items */}
                                                    <div className="flex gap-1 flex-wrap content-end">
                                                        {habits.filter(h => {
                                                            if (h.isInbox) return false;
                                                            if (h.type==='task') return h.targetDate === date;
                                                            if (h.type==='habit') return h.frequency.includes(new Date(date).getDay());
                                                            return false;
                                                        }).slice(0, 4).map(h => (
                                                            <div key={h.id} className={`w-1.5 h-1.5 rounded-full ${completions[date]?.includes(h.id) ? 'bg-green-400' : 'bg-slate-300'}`}></div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* Bottom Graph (30 Day History) */}
                                    <div className="mt-8 h-32 flex items-end justify-between gap-1 p-4 bg-white dark:bg-dark-800 rounded-2xl border border-slate-200 dark:border-dark-700">
                                        {[...Array(30)].map((_, i) => {
                                            const d = new Date();
                                            d.setDate(d.getDate() - (29 - i));
                                            const ds = d.toISOString().split('T')[0];
                                            const val = getDailyStats(ds);
                                            return (
                                                <div key={i} className="flex-1 bg-slate-100 dark:bg-dark-700 rounded-t-sm relative group">
                                                    <div style={{height: `${val}%`}} className={`w-full rounded-t-sm transition-all ${val === 100 ? 'bg-indigo-500' : 'bg-indigo-300'}`}></div>
                                                    <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 hidden group-hover:block bg-black text-white text-xs p-1 rounded whitespace-nowrap z-50">
                                                        {ds}: {val}%
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        ) : (
                            /* INBOX VIEW */
                            <div className="p-12 max-w-3xl mx-auto w-full animate-in">
                                <header className="mb-12">
                                    <div className="inline-flex items-center gap-2 px-3 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-full text-xs font-bold uppercase tracking-wider mb-4">
                                        <Icons.Inbox /> Inbox
                                    </div>
                                    <h2 className="text-4xl font-black text-slate-800 dark:text-white mb-2">Unscheduled Tasks</h2>
                                    <p className="text-slate-500 dark:text-slate-400 text-lg">Capture now, schedule later.</p>
                                </header>

                                <div className="space-y-4">
                                    {habits.filter(h => h.isInbox).map(task => (
                                        <div key={task.id} className="group bg-white dark:bg-dark-800 p-6 rounded-2xl border border-slate-200 dark:border-dark-700 shadow-sm hover:shadow-md transition-all flex justify-between items-center">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 bg-slate-100 dark:bg-dark-700 rounded-2xl flex items-center justify-center text-2xl">
                                                    {task.icon}
                                                </div>
                                                <div>
                                                    <h3 className="font-bold text-lg dark:text-slate-200">{task.name}</h3>
                                                    <p className="text-sm text-slate-400 flex items-center gap-1">
                                                        {task.subtasks?.length > 0 && <span>{task.subtasks.filter(s=>s.completed).length}/{task.subtasks.length} subtasks â€¢ </span>}
                                                        Waitlist
                                                    </p>
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => {setEditingItem(task); setIsModalOpen(true);}}
                                                className="px-4 py-2 bg-indigo-50 dark:bg-dark-600 text-indigo-600 dark:text-indigo-400 font-bold rounded-xl text-sm opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                Schedule
                                            </button>
                                        </div>
                                    ))}
                                    {habits.filter(h => h.isInbox).length === 0 && (
                                        <div className="text-center py-20 border-2 border-dashed border-slate-200 dark:border-dark-700 rounded-3xl">
                                            <p className="text-slate-400 font-medium">Inbox Zero. Great job!</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* RIGHT SIDEBAR: AGENDA */}
                    <aside className="w-96 bg-white dark:bg-dark-800 border-l border-slate-200 dark:border-dark-700 flex flex-col z-20 shadow-xl overflow-hidden">
                        <div className="p-6 border-b border-slate-100 dark:border-dark-700 bg-white/80 dark:bg-dark-800/80 backdrop-blur-md sticky top-0 z-10">
                            <h2 className="text-xl font-black mb-1">Agenda</h2>
                            <p className="text-sm text-slate-400 font-medium">{new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                            
                            {/* Daily Progress Bar */}
                            <div className="mt-4 h-2 bg-slate-100 dark:bg-dark-700 rounded-full overflow-hidden">
                                <div style={{width: `${getDailyStats(selectedDate)}%`}} className="h-full bg-indigo-500 transition-all duration-500"></div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide">
                            {habits.filter(h => {
                                if (h.isInbox || h.archived) return false;
                                if (h.type === 'task' || h.type === 'event') return h.targetDate === selectedDate;
                                return h.frequency.includes(new Date(selectedDate).getDay());
                            }).sort((a,b) => (a.time||'').localeCompare(b.time||'')).map(h => {
                                const isCompleted = completions[selectedDate]?.includes(h.id);
                                return (
                                    <div key={h.id} className={`group p-4 rounded-2xl border transition-all ${isCompleted ? 'bg-slate-50 border-transparent opacity-60 dark:bg-dark-700/50' : 'bg-white border-slate-100 dark:bg-dark-700 dark:border-dark-600 shadow-sm'}`}>
                                        <div className="flex items-start gap-3">
                                            <button 
                                                onClick={() => toggleComplete(h.id, selectedDate)}
                                                className={`mt-1 w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${isCompleted ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-slate-300 hover:border-indigo-400'}`}
                                            >
                                                {isCompleted && <Icons.Check size={14} />}
                                            </button>
                                            
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className={`font-bold text-sm ${isCompleted ? 'line-through text-slate-400' : ''}`}>{h.icon} {h.name}</h3>
                                                        {h.time && <p className="text-[10px] text-slate-400 font-bold mt-0.5">{h.time}</p>}
                                                    </div>
                                                    
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        {h.useTimer && !isCompleted && (
                                                            <button onClick={() => setActiveFocusHabit(h)} className="text-slate-400 hover:text-indigo-500"><Icons.Play /></button>
                                                        )}
                                                        <button onClick={() => {setEditingItem(h); setIsModalOpen(true);}} className="text-slate-400 hover:text-indigo-500"><Icons.Edit /></button>
                                                    </div>
                                                </div>

                                                {/* SUBTASKS RENDERING */}
                                                {h.subtasks && h.subtasks.length > 0 && (
                                                    <div className="mt-3 space-y-2 border-l-2 border-slate-100 dark:border-dark-600 pl-3">
                                                        {h.subtasks.map((st, idx) => (
                                                            <div 
                                                                key={idx} 
                                                                onClick={(e) => { e.stopPropagation(); toggleSubtask(h.id, idx); }}
                                                                className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-dark-600 p-1 rounded"
                                                            >
                                                                <div className={`w-3 h-3 rounded border flex items-center justify-center ${st.completed ? 'bg-indigo-400 border-indigo-400' : 'border-slate-300'}`}>
                                                                    {st.completed && <Icons.Check size={8} className="text-white" />}
                                                                </div>
                                                                <span className={`text-xs ${st.completed ? 'line-through text-slate-400' : 'text-slate-600 dark:text-slate-300'}`}>{st.text}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            
                            {/* Empty State */}
                            {habits.filter(h => h.targetDate === selectedDate || (h.type === 'habit' && h.frequency.includes(new Date(selectedDate).getDay()))).length === 0 && (
                                <div className="text-center py-10 opacity-50">
                                    <p className="text-sm">No items for this day.</p>
                                </div>
                            )}
                        </div>
                    </aside>

                    {/* MODALS */}
                    <HabitModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onSave={handleSave} 
                        onDelete={deleteItem}
                        initialData={editingItem} 
                    />
                    
                    {activeFocusHabit && (
                        <FocusTimer 
                            habit={activeFocusHabit} 
                            onClose={() => setActiveFocusHabit(null)} 
                            onComplete={() => toggleComplete(activeFocusHabit.id, selectedDate)} 
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
