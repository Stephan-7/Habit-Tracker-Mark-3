<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Habit OS â€” Local Only (Compact)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f7fb; --muted:#6b7280; --card:rgba(255,255,255,0.92);
  --accent1:#6b46ff; --accent2:#7c3aed; --radius:12px;
  --shadow:0 10px 30px rgba(16,24,40,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#f8f9fc,var(--bg));font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#0f172a}
.app{min-height:100vh;display:flex;gap:20px;padding:24px;align-items:stretch}
.panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:12px;border:1px solid rgba(15,23,42,0.04);min-height:0}
.left{width:260px;flex-shrink:0}
.right{width:320px;flex-shrink:0}
.center{flex:1;display:flex;flex-direction:column;gap:12px;min-height:0}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.muted{color:var(--muted);font-size:13px}
.list{display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:6px;max-height:calc(100vh - 320px)}
.card{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.94));border:1px solid rgba(15,23,42,0.04);transition:transform .12s}
.card:hover{transform:translateY(-4px)}
.icon{width:44px;height:44px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px}
.meta{flex:1}
.title{font-weight:600}
.sub{font-size:12px;color:var(--muted);margin-top:6px}
.progress{height:6px;background:#f1f5f9;border-radius:6px;margin-top:8px;overflow:hidden}
.progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2))}
.controls{display:flex;gap:8px}
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 6px 18px rgba(79,70,229,0.08)}
.calendar{display:flex;flex-direction:column;gap:10px;flex:1;min-height:0}
.cal-head{display:flex;align-items:center;justify-content:space-between}
.cal-grid-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;flex:1;min-height:0;overflow:auto;padding:8px}
.cal-day{padding:10px;border-radius:10px;text-align:center;font-size:13px;border:1px solid transparent;min-height:72px;display:flex;flex-direction:column;justify-content:space-between;background:transparent}
.cal-day:hover{background:#fff}
.cal-day.sel{background:linear-gradient(180deg,#eef2ff,#f5f7ff);border:1px solid rgba(99,102,241,0.14);box-shadow:0 6px 18px rgba(99,102,241,0.06)}
.weekday{font-size:12px;color:var(--muted);text-align:center}
.dots{display:flex;gap:6px;justify-content:center;margin-top:8px}
.dot{width:8px;height:8px;border-radius:8px}
.heat{display:flex;gap:8px;overflow-x:auto;padding:8px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.5));align-items:center}
.heat .sq{width:14px;height:14px;border-radius:4px;flex:0 0 auto}
.agenda{display:flex;flex-direction:column;gap:10px;overflow:auto;min-height:0}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;color:var(--muted)}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.28);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:100%;max-width:760px;background:var(--card);border-radius:12px;padding:16px;border:1px solid rgba(15,23,42,0.04)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.field{display:flex;flex-direction:column;gap:6px}
.field input,.field select{padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff}
.freq{display:flex;gap:6px}
.freq button{width:36px;height:36px;border-radius:999px;border:1px solid rgba(15,23,42,0.06);background:#fff;cursor:pointer}
.freq button.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none}
.small{font-size:13px;color:var(--muted)}
@media (max-width:980px){ .left,.right{display:none} .app{padding:12px} .cal-day{min-height:64px} }
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="panel left">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="brand"><div class="logo">H</div><div><div style="font-weight:700">Habit OS</div><div class="small muted">Local Mode</div></div></div>
      <div class="small muted">v1</div>
    </div>

    <div><div class="small muted">Backup ID</div><div style="font-family:monospace;margin-top:8px;background:#fff;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)" id="backup">local_user</div></div>

    <div class="small muted">All Items</div>
    <div class="list" id="list"></div>

    <div style="margin-top:auto;display:flex;gap:8px">
      <button class="btn primary" id="addLeft">+ New</button>
      <button class="btn" id="exportBtn">Export</button>
    </div>
  </aside>

  <main class="center">
    <div class="panel calendar">
      <div class="cal-head">
        <div><div class="small muted" id="monthLabel">Month</div><div style="font-weight:700" id="monthTitle"></div></div>
        <div class="controls">
          <button class="btn" id="prev">â—€</button>
          <button class="btn" id="today">Today</button>
          <button class="btn" id="next">â–¶</button>
        </div>
      </div>

      <div class="cal-grid-head" id="weekHead"></div>
      <div class="cal-grid" id="calGrid"></div>

      <div class="small muted">Consistency</div>
      <div class="heat" id="heat"></div>
    </div>
  </main>

  <aside class="panel right">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-weight:700" id="selected">2026-02-07</div><div class="small muted">Your day</div></div>
      <div class="small muted">â€¢</div>
    </div>

    <div class="agenda" id="agenda"></div>
    <button class="btn primary" id="addRight">+ Add Item</button>
  </aside>
</div>

<!-- Modal -->
<div id="modal" class="modal-back" style="display:none">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">New Item</div>
      <div><button class="btn" id="closeModal">Close</button></div>
    </div>

    <form id="form">
      <div class="form-grid">
        <div class="field"><label class="small">Name</label><input id="f_name" required></div>
        <div class="field"><label class="small">Type</label><select id="f_type"><option value="habit">Routine</option><option value="task">Task</option><option value="event">Event</option><option value="birthday">Birthday</option></select></div>
        <div class="field"><label class="small">Category</label><select id="f_cat"><option>General</option><option>Health</option><option>Work</option><option>Social</option><option>Learning</option></select></div>
        <div class="field"><label class="small">Difficulty</label><select id="f_diff"><option>Easy</option><option>Medium</option><option>Heroic</option></select></div>
        <div class="field"><label class="small">Monthly goal</label><input id="f_goal" type="number" min="1" placeholder="e.g., 15"></div>
        <div class="field"><label class="small">Time</label><input id="f_time" type="time"></div>
        <div style="grid-column:1/3"><label class="small">Frequency</label><div class="freq" id="freq"><button type="button" data-day="0">S</button><button type="button" data-day="1">M</button><button type="button" data-day="2">T</button><button type="button" data-day="3">W</button><button type="button" data-day="4">T</button><button type="button" data-day="5">F</button><button type="button" data-day="6">S</button></div></div>
        <div class="field"><label class="small">Date</label><input id="f_date" type="date"></div>
        <div class="field"><label class="small">Use timer</label><input id="f_timer" type="checkbox"></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button type="button" class="btn" id="cancel">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
/* =========================
   Local-only Habit OS
   - Stores everything in localStorage
   - Compact, robust, event-delegated
   ========================= */

const LS_KEY = "habit_os_local_v1";
const todayStr = () => new Date().toISOString().slice(0,10);
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,6);
const dateObj = s => new Date(s + "T00:00:00");
const ymd = d => d.toISOString().slice(0,10);

const defaultStore = () => ({
  habits: [
    { id: uid(), name: "Daily Planning", type: "habit", category: "Work", difficulty: "Easy", monthlyGoal: 20, time: "", frequency: [1,2,3,4,5], useTimer: true, archived:false, order:0, icon:"ðŸ§ " }
  ],
  completions: {},
  settings: { backupId: "local_" + Math.random().toString(36).slice(2,8) },
  view: { selected: todayStr(), offset: 0 }
});

let store = JSON.parse(localStorage.getItem(LS_KEY) || "null") || defaultStore();
const save = () => localStorage.setItem(LS_KEY, JSON.stringify(store));

/* helpers */
const $ = id => document.getElementById(id);
const clamp = (v,a,b) => Math.max(a,Math.min(b,v));

/* calendar helpers */
function monthDays(offset){
  const base = new Date(); base.setDate(1); base.setMonth(base.getMonth()+offset);
  const y = base.getFullYear(), m = base.getMonth();
  const first = new Date(y,m,1), start = first.getDay();
  const days = new Date(y,m+1,0).getDate();
  const cells = [];
  for(let i=0;i<start;i++) cells.push(null);
  for(let d=1;d<=days;d++) cells.push(new Date(y,m,d));
  return {cells,monthDate:first};
}

/* due/completion logic */
function isDue(h,date){
  const d = dateObj(date);
  if(h.type==="habit"){
    const freq = h.frequency && h.frequency.length ? h.frequency : [0,1,2,3,4,5,6];
    return !h.archived && freq.includes(d.getDay());
  }
  if(h.type==="task"||h.type==="event") return !h.archived && h.target === date;
  if(h.type==="birthday"){ if(!h.target) return false; const td = dateObj(h.target); return !h.archived && td.getDate()===d.getDate() && td.getMonth()===d.getMonth(); }
  return false;
}
function dueItems(date){ return store.habits.filter(h=>isDue(h,date) && !h.archived); }
function addDone(date,id){ const c = store.completions[date]||[]; if(!c.includes(id)) c.push(id); store.completions[date]=c; save(); }
function removeDone(date,id){ const c = store.completions[date]||[]; store.completions[date]=c.filter(x=>x!==id); if(!store.completions[date].length) delete store.completions[date]; save(); }

/* streak/monthly */
function streakForHabit(h){
  let streak=0; let d = dateObj(todayStr());
  for(let i=0;i<365;i++){
    const ds = ymd(d);
    if(isDue(h,ds)){
      const done = (store.completions[ds]||[]).includes(h.id);
      if(done) streak++; else break;
    } else break;
    d.setDate(d.getDate()-1);
  }
  return streak;
}
function monthlyCount(h){
  if(!h.monthlyGoal) return 0;
  const now = dateObj(todayStr()), y = now.getFullYear(), m = now.getMonth();
  let count=0;
  Object.entries(store.completions).forEach(([date,ids])=>{
    const d = dateObj(date);
    if(d.getFullYear()===y && d.getMonth()===m && ids.includes(h.id)) count++;
  });
  return count;
}

/* heatmap last 30 days */
function last30(){
  const arr=[]; const base = dateObj(todayStr());
  for(let i=29;i>=0;i--){
    const d = new Date(base); d.setDate(d.getDate()-i);
    const ds = ymd(d);
    const due = store.habits.filter(h=>["habit","task"].includes(h.type) && isDue(h,ds));
    const done = (store.completions[ds]||[]).length;
    arr.push({date:ds,total:due.length,done});
  }
  return arr;
}

/* render */
function render(){
  $("backup").textContent = store.settings.backupId;
  const sel = store.view.selected;
  $("selected").textContent = sel;

  // left list
  const list = $("list"); list.innerHTML = "";
  store.habits.filter(h=>!h.archived).sort((a,b)=>a.order - b.order).forEach(h=>{
    const s = streakForHabit(h), m = monthlyCount(h), pct = h.monthlyGoal ? clamp(Math.round((m/(h.monthlyGoal||1))*100),0,100) : 0;
    const div = document.createElement("div"); div.className="card";
    div.innerHTML = `<div class="icon">${h.icon||"â€¢"}</div><div class="meta"><div class="title">${h.name}</div><div class="sub">${h.type} â€¢ ${h.category||"General"}</div><div class="progress"><i style="width:${pct}%"></i></div><div class="small" style="margin-top:8px">Streak ${s} â€¢ ${m}${h.monthlyGoal?` / ${h.monthlyGoal}`:""}</div></div><div class="actions"><button class="btn" data-edit="${h.id}">Edit</button></div>`;
    list.appendChild(div);
  });

  // calendar
  const m = monthDays(store.view.offset);
  $("monthLabel").textContent = m.monthDate.toLocaleDateString(undefined,{month:"long",year:"numeric"});
  $("monthTitle").textContent = m.monthDate.toLocaleDateString(undefined,{month:"long",year:"numeric"});
  $("weekHead").innerHTML = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(w=>`<div class="weekday">${w}</div>`).join("");
  $("calGrid").innerHTML = m.cells.map(d=>{
    if(!d) return `<div></div>`;
    const ds = ymd(d), selc = ds===sel ? "cal-day sel" : "cal-day";
    const dots = store.habits.map(h=>{ if(h.type==="event" && isDue(h,ds)) return `<div class="dot" style="background:#60a5fa"></div>`; if(h.type==="birthday" && isDue(h,ds)) return `<div class="dot" style="background:#fb7185"></div>`; return ""; }).filter(Boolean).slice(0,3).join("");
    return `<button data-date="${ds}" class="${selc}"><div style="font-weight:700">${d.getDate()}</div><div class="dots">${dots}</div></button>`;
  }).join("");

  // heatmap
  $("heat").innerHTML = last30().map(h=>{ const pct = h.total ? h.done / h.total : 0; const color = pct===1 ? "#6b46ff" : pct>=0.5 ? "#a78bfa" : pct>0 ? "#c7b3ff" : "#e6e9ef"; return `<div class="sq" style="background:${color}" title="${h.date}"></div>`; }).join("");

  // agenda
  const agenda = $("agenda"); agenda.innerHTML = "";
  const due = dueItems(sel);
  if(!due.length) agenda.innerHTML = `<div class="empty"><div class="emoji">ðŸŽˆ</div><div class="small">Nothing scheduled</div></div>`;
  else due.forEach(h=>{
    const done = (store.completions[sel]||[]).includes(h.id);
    const node = document.createElement("div"); node.className="card";
    node.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="font-size:20px">${h.icon||"â€¢"}</div><div><div style="font-weight:700">${h.name}</div><div class="small">${h.type}${h.time?` â€¢ ${h.time}`:""}</div></div></div><div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">${h.useTimer && (h.type==="habit"||h.type==="task")?`<button class="btn" data-timer="${h.id}">Start</button>`:""}<button class="btn" data-toggle="${h.id}">${done?"Done":"Mark"}</button></div>`;
    agenda.appendChild(node);
  });
}

/* event delegation */
document.getElementById("app").addEventListener("click", e=>{
  const b = e.target.closest("[data-date],[data-edit],[data-toggle],[data-timer]");
  if(!b) return;
  if(b.dataset.date){ store.view.selected = b.dataset.date; save(); render(); return; }
  if(b.dataset.edit){ const id=b.dataset.edit; openModal(store.habits.find(x=>x.id===id)); return; }
  if(b.dataset.toggle){ const id=b.dataset.toggle; const d=store.view.selected; const done=(store.completions[d]||[]).includes(id); if(done) removeDone(d,id); else addDone(d,id); render(); return; }
  if(b.dataset.timer){ startTimer(b.dataset.timer, store.view.selected); return; }
});

/* static controls */
$("prev").onclick = ()=>{ store.view.offset--; save(); render(); };
$("next").onclick = ()=>{ store.view.offset++; save(); render(); };
$("today").onclick = ()=>{ store.view.selected = todayStr(); store.view.offset = 0; save(); render(); };
$("addLeft").onclick = ()=>openModal();
$("addRight").onclick = ()=>openModal();
$("exportBtn").onclick = ()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(store)],{type:"application/json"})); a.download="habit_os_backup.json"; a.click(); };

/* modal logic */
const modal = $("modal"), form = $("form");
$("closeModal").onclick = ()=>{ modal.style.display="none"; modal.dataset.edit=""; };
$("cancel").onclick = ()=>{ modal.style.display="none"; modal.dataset.edit=""; };
document.querySelectorAll("#freq button").forEach(b=>b.onclick=()=>b.classList.toggle("active"));

function openModal(h=null){
  const f = h ? h : { id: uid(), name:"", type:"habit", category:"General", difficulty:"Easy", monthlyGoal:null, time:"", frequency:[1,2,3,4,5], target: todayStr(), useTimer:false, icon:"â€¢" };
  $("f_name").value = f.name || "";
  $("f_type").value = f.type || "habit";
  $("f_cat").value = f.category || "General";
  $("f_diff").value = f.difficulty || "Easy";
  $("f_goal").value = f.monthlyGoal || "";
  $("f_time").value = f.time || "";
  $("f_date").value = f.target || "";
  $("f_timer").checked = !!f.useTimer;
  document.querySelectorAll("#freq button").forEach(btn=>{ const day=parseInt(btn.dataset.day); btn.classList.toggle("active", (f.frequency||[0,1,2,3,4,5,6]).includes(day)); });
  modal.style.display = "flex";
  modal.dataset.edit = h ? h.id : "";
}

/* form submit */
form.onsubmit = e=>{
  e.preventDefault();
  const id = modal.dataset.edit || uid();
  const name = $("f_name").value.trim() || "Untitled";
  const type = $("f_type").value;
  const category = $("f_cat").value;
  const difficulty = $("f_diff").value;
  const monthlyGoal = $("f_goal").value ? parseInt($("f_goal").value) : null;
  const time = $("f_time").value || "";
  const target = $("f_date").value || todayStr();
  const useTimer = $("f_timer").checked;
  const freq = Array.from(document.querySelectorAll("#freq button")).filter(b=>b.classList.contains("active")).map(b=>parseInt(b.dataset.day));
  const item = { id, name, type, category, difficulty, monthlyGoal, time, target, useTimer, frequency: freq.length?freq:[0,1,2,3,4,5,6], archived:false, order: store.habits.length, icon:"â€¢" };
  const existing = store.habits.find(x=>x.id===id);
  if(existing){ store.habits = store.habits.map(x=> x.id===id ? item : x); } else store.habits.push(item);
  if(["task","event","birthday"].includes(type)){ store.view.selected = target; const t = dateObj(target), now = new Date(); store.view.offset = (t.getFullYear()-now.getFullYear())*12 + (t.getMonth()-now.getMonth()); }
  save(); modal.style.display="none"; modal.dataset.edit=""; render();
};

/* simple timer overlay */
let _timer = null;
function startTimer(id,date){
  const h = store.habits.find(x=>x.id===id); if(!h) return;
  if(_timer) clearInterval(_timer);
  let rem = 25*60;
  const overlay = document.createElement("div"); overlay.className="modal-back"; overlay.id="timerOverlay";
  overlay.innerHTML = `<div class="modal" style="max-width:420px;text-align:center"><div class="small">Focus Session</div><div id="t_time" style="font-size:32px;font-weight:700;margin:12px 0">25:00</div><div class="small" id="t_label">${h.name}</div><div style="margin-top:12px"><button class="btn" id="t_cancel">Cancel</button></div></div>`;
  document.body.appendChild(overlay);
  const ttime = $("t_time"), tcancel = $("t_cancel");
  _timer = setInterval(()=>{ rem--; const m = String(Math.floor(rem/60)).padStart(2,"0"); const s = String(rem%60).padStart(2,"0"); if(ttime) ttime.textContent = `${m}:${s}`; if(rem<=0){ clearInterval(_timer); _timer=null; addDone(date,id); overlay.remove(); render(); } },1000);
  tcancel.onclick = ()=>{ if(_timer) clearInterval(_timer); _timer=null; overlay.remove(); };
}

/* initial render */
render();
</script>
</body>
</html>
